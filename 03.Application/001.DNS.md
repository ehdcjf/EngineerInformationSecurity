# DNS

## DNS 구조

### 용어 정리

__1. Recursive/Cache 네임서버/DNS서버__

- 재귀적으로 동일한 작업을 조건이 만족될 때까지 반복적으로 처리한다는 의미
- 관리하는/위임받은 도메인 없이 사용자 호스트로부터 질의가 들어오면 자신의 캐시에 저장된 정보 또는 반복적 질의(Iterative Query)를 통해 그 결과를 사용자 호스트에 응답해주는 네임서버
- 일반적으로 ISP 업체(인터넷 서비스 제공 업체)가 제공해주는 DNS서버에 해당된다. (e.g KT:kns.kornet.net/168.126.63.1)
<br>

 **2. Authoritative 네임서버/DNS서버**

- Authoritative는 권한있는. 권위있는 이라는 뜻으로 관리하는/위임받은 도메인을 가지고 있는 네임서버를 말한다. 즉, 특정 도메인에 대한 정보를 관리하면서 해당 도메인에 대한 질의에만 응답해주는 네임서버이다.
- 네임서버가 관리하는 도메인 영역을 존(Zone)이라 하고, 관리 도메인에 대한 정보를 담고 있는 파일을 존 파일(Zone File)이라고 한다. 네임서버는 존 파일을 읽어들여 존 데이터(Zone Data)를 구성하고 이를 이용하여 질의에 응답한다.
- 각 회사/사이트별로 자신의 도메인을 관리하는 DNS 서버가 해당한다. (e.g Google:nsl.google.com/216.239.32.10)
<br>

**3. 재귀적 질의 (Recursive Query)**

- 사용자 호스트가 Recursive 네임서버로 질의할 때 사용되는 방식으로 Recursive 네임서버로 대상 도메인의 리소스 레코드 정보를 조회해서 응답해 달라는 질의를 의미한다.
- Recursive 네임서버는 자신의 캐시 데이터를 조회한 후 데이터가 있으면, 사용자 호스트로 그 결과를 반환하고, 없으면 최상위 Root네임서버로부터 질의 대상 도메인 네임서버까지 반복적 질의(Iterative Query)를 수행한 수 그 결과를 사용자 호스트에 반환한다.
<br>

 **4. 반복적 질의(Iterative Query)**

- Recursive 네임서버가 도메인을 관리하는 각 네임서버(Authoriative 네임서버)로 질의할 때 사용하는 방식이다.
- 최상위 Root네임서버부터 계층구조에 따라 대상 도메인 네임서버까지 각 네임서버가 응답하는 위임된 네임서버 정보에 따라  순차적으로 반복하여 진행하는 질의를 의미한다.
<br>

### 동작 방식

1. 사용자 호스트가 네임서버에 접속하고자하는 도메인/URL에 대한 IP 주소를 질의한다. 이를 DNS질의라고 한다. <br>
※ 윈도우 호스트의 경우 질의에 대한 검색 순서는 로컬 DNS캐시, host.ics, hosts파일 순으로 검색하고 없으면 시스템에 설정된 네임서버로 요청한다. 
<br>

* host.ics
host.ics 파일은 윈도우에서 인터넷 연결 공유 기능 사용 시 클라이언트 IP를 강제로 지정하는 기능을 가진 설정 파일이다. 중요한 점은 hosts파일보다 DNS 질의에 대한 검색 우선순위가 높으므로 질의 시 먼저 참조되는 특성이 있다. 따라서 악성 코드에 조작된 host.ics파일을 생성하여 파밍 사이트로 접속을 유도하는 보안 사고가 발생한 사례가 있어 주의해야 한다. 

2. Linux/Unix 기준 네임서버 관련 설정 파일
- **/etc/resolve.conf** 파일은 시스템 기본 네임서버 설정 정보를 담고 있다. 

- **/etc/hosts** 파일은 도메인/호스트명과 IP주소 매핑정보를 담고 있는 파일로 네임서버에 질의하기 전에 먼저 참조되는 파일이다. 파밍 등의 공격을 통해 파밍 사이트로 접속하도록 hosts파일을 변조하는 사례가 자주 보고되며 관리상 주의가 필요하다. 

- **/etc/host.conf** 파일은 DNS 질의 순서를 지정하는 파일로 order 절에 명시된 순서로 질의를 수행한다. 

3. 질의를 받은 네임서버는 해당 도메인 정보가 자신의 캐시에 저장되어 있으면 바로 사용자 호스트에게 응답하고, 없으면 root 네임서버로부터 최종 질의 대상 도메인의 네임서버까지 반복적 질의(Iterative Query)를 수행하여 원하는 정보를 얻는다. 
4. 도메인에 대한 IP 주소를 획득한 네임서버는 질의한 사용자 호스트에 응답한다. 이를 DNS 응답이라고 한다. 
5. 사용자 호스트는 네임서버로부터 받은 IP주소를 일정 시간동안 자신의 DNS캐시에 저장한 후 대상 사이트로 접속한다. 캐시를 이용하는 것은 매번 동일한 도메인에 대한 질의를 수행하는 부하를 줄이기 위한 것으로 DNS 캐시에 있는 정보를 먼저 확인한 후 캐시에 없으면 DNS 질의를 수행한다. 

### 3) 네임서버 질의/응답 패킷 분석

1. 응답 데이터가 512바이트 이하일 경우(일반적인 경우): UDP53번 포트 사용
-  클라이언트는 네임서버의 53/UDP  포트로 DNS 질의 요청을 수행한다. 요청 시 해당 요청에 대한 응답을 식별하기 위해 Transaction ID(2바이트 랜덤값)을 설정한다. 
- 네임서버는 요청한 Transaction ID를 설정하여 질의에 대한 응답(Answer 섹션)을 전송한다. 전체 패킷의 크기가 158byte(Length 필드)로 DNS 응답 데이터가 512바이트 이하이므로 UDP로 응답한다. 

2. 응답데이터가 512바이트를 초과하는 경우: TCP 53번 포트 사용
- 클라이언트의 질의에 대하여 네임서버 처리 결과 512바이트를 초과하면 네임서버는 신뢰성 있는 전송을 보장해주기 위해 TCP로 재요청하도록 응답한다. DNS헤더의 플래그 중 Truncated설정이 되어 있으면 TCP로 재요청하라는 의미이다. 
- 클라이언트는 TCP(53번 포트)로 질의 요청을 전송한다. 

## DNS Cache 관련 명령어

###  `ipconfig /displaydns`: 로컬 DNS 캐시 정보 조회하기

- TTL: 해당 캐시 정보를 유지하는 시간(초 단위)를 의미하며 TTL이 만료되면 해당 정보는 삭제
- DNS 스푸핑 공격(스니핑 기반)을 당하게 되면 캐시에 조작된 주소 정보가 저장된다. 이 경우 위 명령을 통하여 조작된 주소를 확인할 수 있다.

###  `ipconfig /flushdns`: 로컬 DNS 캐시 정보 삭제하기

##  DNS Lookup 명령어

- DNS Lookup(질의) 유형에는 forward DNS lookup(순방향 룩업)과 reserve DNS lookup(역방향 룩업)이 있다.
- 순방향 룩업은 도메인명을 통해서 IP 주소를 알아내는 질의를 의미하며, 역방향 룩업은 IP주소를 통해서 도메인 명을 알아내는 질의를 말한다.
- DNS Lookup을 위한 대표적인 명령으로 ‘nslookup’ 과 ‘dig’ 명령이 있다.
- DNS Lookup을 위해서는 질의 유형에 대한 이해가 필요하다. 질의 유형은 도메인 존 파일에 저장된 각각의 레코드 타입을 말하는 것으로 질의 시에 해당 유형을 지정하면 해당 유형의 응답을 주게 된다.

|  |  |
| --- | --- |
| A(address) | • 도메인에 대한 IP 주소 질의(A 레코드 질의) |
| Any | • 도메인에 대한 모든 레코드 질의 <br>•  일반적으로 요청 대비 응답이 크기 때문에 DNS 증폭 DRDos 공격에 악용됨 |
| MX(Mail Exchanger) | • 도메인의 메일 서버 질의(MX레코드 질의) |
| NS(Name Server) | • 도메인의 네임서버 질의 (NS레코드 질의) |
| SOA(Start of Authority) | •  존(Zone) 의 기본 속성(존 파일의 버전, 존 전송 주기 등) 질의 (SOA레코드 질의) |
| TXT(Text) | • 도메인에 대한 텍스트 정보 질의 (TXT레코드 질의)<br>•  TXT레코드에는 대표적으로 SPF(발송자 메인서버 인증)레코드 정보가 있다. <br>•  일반적으로 요청 대비 응답이 크기 때문에 DNS 증폭 DRDos 공격에 악용됨 |
| PTR(Pointer) | • IP에 대한 도메인 정보 질의 (A 유형의 반대)<br>• Reverse Zone 파일에 설정된 PTR 레코드 질의 |
| AXFR(Authoritative Zone Transfer) | • 존 버전에 상관없이 무조건 존 전송 요청 (Full Zone Transfer)<br>• 형식) dig @[마스터 네임서버 주소] [zone name] axfr<br>• 예시) dig @192.168.222.132 ehdcjf.com axfr |
| IXFR(Incremental Zone Transfer) | • 존 버전을 비교하여 상위 버전일 경우 존 전송 요청 (Incremental Zone Transfer)<br>• 형식) dig @[마스터 네임서버 주소] [zone name] ixfr=버전정보<br>• 예시) dig @192.168.222.132 http://ehdcjf.com ixfr=20230510 |

### `nslookup` 명령어

* 명령 실행 후 대화형 모드로 질의

* `nslookup [도메인] [네임서버]` : 질의할 도메인을 지정한 네임서버로 질의

*  `server [dns 서버주소]` 
: 질의할 네임서버 지정. 지정하지 않으면 시스템에 설정된 기본 네임서버 사용

*  `set type=[질의 유형]`
: 질의할 유형을 지정. 지정하지 않으면 A레코드(IP주소)에 대한 질의 수행

### `dig` 명령어

1. nslookup을 대체하기 위한 목적으로 만들어진 명령어로 Linux 및 Unix계열의 OS에는 기본적으로 설치되어 있다. 
2.  `dig [@네임서버] [쿼리유형] [쿼리옵션]`<br>
• @네임서버: 사용할 네임서버지정. 생략하면 해당 시스템에 설정된 기본 네임서버를 이용<br>
• 질의 유형: 질의 유형을 생략하면 기본적으로 A유형 질의(도메인 IP 주소 질의)를 수행<br>
• 질의 옵션: 네임서버 점검을 위한 주요 옵션은 다음과 같다. <br>

dig 쿼리 옵션

|옵션| 의미|
|--|--|
|+norecurse|• authoritative 네임서버에 반복적 질의(Iterative Query)를 수행하여 정상 응답 여부 점검. <br> • 예) `dig @ns.ehdcjf.com http://www.ehdcjf.com + norecurse` |
|+tcp|• 53/tcp 허용 여부를 점검 <br> • `dig @http://kns.kornet.net http://www.ehdcjf.com +tcp` <br>: kns.kornet.net 네임서버가 53/tcp를 허용하는지 여부 점검 |
|+trace| •  계층적 위임설정 상태 점검 <br> • 최상위 루트 도메인부터 최종 질의 대상 도메인까지 계층구조에 따른 질의 수행<br> • 예) `dig @kns.kornet.net http://www.ehdcjf.com +trace` |


###  `whois` 명령어

1. whois 서버를 통해 해당 도메인의 등록정보(소유정보), 네트워크 할당 정보 등을 조회하기 위한 명령어
2. 해당 도메인 명이 다른 사람에 의해 사용 중인지를 점검하는 용도로 많이 사용
3. 사용법<br>
•  `whois 도메인명`
: 해당 도메인의 등록정보/소유정보, 네임서버 정보 등을 조회한다. <br>
• `whois Ip주소`
: 해당 주소의 네트워크 대역을 관리하는 대행자(IPS)정보, 네트워크 할당 정보 등을 확인할 수 있다. 

## DNS 스푸핑(Spoofing) 공격
1. DNS 스푸핑은 희생자(공격 대상)에게 전달되는 DNS응답(IP 주소)을 조작하거나 DNS서버의 캐시(Cache) 정보를 조작하여 희생자가 의도하지 않은 주소로 접속하게 만드는 공격을 말한다.   
 따라서 희생자 입장에서는 정상적인 URL로 접속하지만 실제로는 공격자가 만든 가까 사이트(Fake Site)로 접속하게 된다. 공격 방법에 따라 크게 2가지로 나눌 수 있다. 

   * 스니핑을 이용한 DNS 스푸핑
   * DNS 캐시 포이즈닝(Cache Poisoning)
2. DNS 스푸핑은 DNS 질의/응답에 사용하는 UDP 프로토콜의 비연결(Connectionless) 특성 취약점을 이용한 공격이다. 클라이언트는 DNS 서버와 연결 상태를 유지하지 않기 때문에 DNS 질의/응답을 식별하기 위한 Transaction ID, 출발지/목적지 주소(IP, Port)만 일치하면 먼저 수신한 응답을 신뢰하고 이후에 수신한 응답을 모두 폐기하는 특성을 이용한 공격이다. 

## 스니핑 기반의 DNS Spoofing 공격

- 희생자가 DNS 질의를 수행하면 공격자가 이를 스니핑하고 있다가 정상 응답보다 빠르게 희생자에게 조작된 웹사이트 IP 정보를 담은 DNS응답을 보내 정상 주소(URL)를 입력해도 조작된 주소로 접속하게 만드는 공격기법.
- 조작된 응답 이후에 도작하는 정상 응답은 먼저 수신한 응답을 신뢰하는 특성으로 인해 폐기
- 더미 허브에 모두 연결되어 있어 무차별모드로 동작 시 스니핑 가능
스위치 환경에서는 ARP 스푸핑 등으로 스니핑
- 일반적으로 스니핑을 통한 DNS 스푸핑 공격은 동일한 네트워크 내에서 발생하기 때문에 상대적으로 멀리 떨어져 있는 (다른 네트워크) DNS 서버보다 공격자가 빠르게 조작된 응답을 보낼 수 있음.
#### 대응책
  1. 스니핑을 이용한 DNS 스푸핑 공격은 기본적으로 스니핑을 이용하기 때문에 이를 탐지 및 차단하도록 한다. 
  2. 중요한 사이트의 IP 주소에 대해서는 DNS 질의보다 우선순위가 높은 hosts 파일에 등록하여 관리한다.

## DNS  Cache Poisoning 공격

- DNS 서버의 캐시정보를 조작하는 공격을 DNS Cache Poisoning 공격이라 한다.
- DNS 서버는 상위 DNS 서버(최상위 root DNS) 서버로부터 계층구조에 따른 DNS 서버에 빈번하게 반복적 질의를 요청하여 부하가 발생하는 것을 막기 위해 **캐시**를 사용하고 **TTL**동안 이를 유지한다.
- DNS 서버 자체를 공격하기 때문에 DNS 서버의 캐시 정보가 일정한 시간(TTL) 유지되는 동안 해당 서버에 접근하는 다수의 사용자가 조작된 DNS응답을 수신하여 대규모의 보안 사고가 발생할 수 있다.

#### 공격방식
1. 공격자는 공격 대상 DNS 서버(Recursive DNS 서버)에 조작할 도메인 질의를 다수 보낸다. 

2. 공격자는 공격 대상 DNS 서버가 반복적 질의를 수행하는 동안 다수의 조작된 DNS응답을 보낸다. 공격자가 다수의 응답을 보내는 이유는 공격대상 DNS서버가 반복적 질의 시 사용하는 TransactionID와 목적지 Port를 모르기 때문에 랜덤한 Transacrion ID와 Port를 다수 생성하여 응답한다. 
※만약 스니핑이 가능한 환경이라면 손쉽게 Transaction ID와 출발지 포트를 알 수 있지만 스니핑이 불가능한 상황을 가정한다. 

1. 공격자의 조작된 응답 중 정상 응답보다 먼저 일치하는 응답이 있으면 조작된 주소 정보가 공격 대상 DNS 서버의 캐시에 저장되고 이를 질의하는 사용자는 조작된 주소의 사이트로 접속하게 된다.

#### 대응책

1. 네임서버의 소프트웨어(e.g Bind DNS)를 최신 버전(패치) 상태로 유지하여 알려진 취약점에 의한 공격이 발생하지 않도록한다. 

2. 도메인 관리용 DNS서버(Authoritative 네임서버)는 재귀적 질의(Recursive Query)를 허용하지 않도록 설정하고, 제한된 사용자가 사용하는 Recursive DNS 서버라면 해당 사용자로 제한해서 사용한다. 

3. DNSSEC(DNS Security Extention) 기술 활용
*  데이터 위변조 공격에 취약한 DNS의 문제점을 근본적으로 개선하기 위해 IETF에 의해 2005년 완성된 국제 표준 기술이다. 
* DNSSEC은 DNS를 대체하는 것이 아니라, 기존의 DNS에 공개키 암호화 방식의 보안 기능을 추가 부여하여 DNS의 보안성을 대폭 강화하는 역할을 한다.    


## DNS 서버(Bind DNS) 보안

###  Master/Slave  네임서버(DNS 서버) 이해하기

도메인 네임서버는 도메인의 존 데이터(Zone Data) 관리 측면에서 원본 존 데이터를 관리하는 마스터(Master) 네임서버와 이를 동기화해서 사용하는 슬레이브(Slave) 네임서버로 구분한다. 

존 데이터는 관리하는 도메인 영역(Zone) 정보(데이터베이스)로 다양한 레코드 유형에 따른 데이터를 가지고 있으며 일반적으로 관리자가 설정한 존 파일을 읽어 들여 존 데이터를 구성한다. 

마스터에 있는 원본 존 데이터를 슬레이브가 동기화하는 작업을 존 전송(Zone Transfer)이라 한다. 존 전송은 일반적으로 많은 존 데이터가 이동해야 하므로 신뢰성 있는 전송을 보장하는 TCP(53포트)를 이용한다. 

마스터(1차 네임서버) 와 슬레이브(2차 네임서버)는 서로 동일한 기능을 수행하며 부하 분산을 통해 안전성을 높이는 역할을 한다. 

사용자 호스트 측면에서 보면 1차 네임서버에 질의해서 응답이 없거나 에러가 발생하면 2차 네임서버로 다시 질의한다. 물론 1차 및 2차 네임서버가 사용자 호스트에 설정되어 있어야 한다. 

리졸버(Resolver):  네임서버로 질의를 수행하여 그 결과를 응용 프로그램에 반환해주는 소프트웨어 모듈/라이브러리를 말한다. 

###  Zone File 이해하기

네임서버 설정파일(named.conf)에 존 설정한다.  

type master는 마스터 네임서버를 의미한다. 

file "kiwi99.com.db" 는 관리하는 도메인(kiwi99.com)의 리소스 레코드 정보를 담고 있는 존 파일(Zone File)명을 의미한다. 

 56.168.192.in-addr.arp 도메인은 리버스 도메인으로 reverse-lookup(IP에 대한 도메인명 질의)을 위한 특수 도메인이다. 

 리버스 도메인의 구성은 점으로 구분된 십진수 IP 주소에서 숫자의 순서를 역으로 정렬하여 [in-addr.arpa](http://in-addr.arpa) 도메인의 하위 도메인으로 구성한다. 

 리버스 도메인에 대한 존 파일을 리버스 존 파일(Reverse Zone File)이라 한다. 

options의 dirctory 항목이 존 파일이 위치한 경로를 나타낸다. 

존 파일은 네임서버 설정 시 가장 중요한 도메인 데이터베이스 파일로 네임서버 기동 시에 존 파일을 읽어들여 존 데이터를 구성한다. 

존 파일의 리소스 레코드 형식은 다음과 같다. 

| host_name |  [TTL] |  class |  record_type |  data |
|--|--|--|--|--|
||||||
 

*  host_name: 등록할 호스트명을 지정한다. 

*  TTL: 레코드의 TTL 값을 지정한다. 미지정시 default 값(첫 행의 $TTL)을 적용받는다. 

*  class: 인터넷 클래스를 의미하는 IN 지정

*  record_type: 레코드 유형을 지정한다. 

*  data: 레코드 유형에 따른 데이터 설정

리버스 존 파일을 살펴보면 PTR 레코드 유형을 이용하여 IP주소에 대한 도메인 명을 설정하고 있다. 

존 파일의 주요 리소스 레코드 유형 및 역할

| 질의 유형 | 설명 |
| --- | --- |
| A(address) | • 호스트의 IP(IPv4)정보  |
| AAAA | • 호스트의 IP(IPv6)정보 |
| MX(Mail Exchanger) | • 도메인의 메일 서버 질의 |
| NS(Name Server) | • 도메인의 네임서버 질의 |
| SOA(Start of Authority) | •  존(Zone) 의 시작을 표현하는 레코드로 존의 기본 속성 정보(존 파일의 버전, 존 전송 주기 등)를 담고 있다.  |
| HINFO(host informatoin) | •  호스트의 CPU, OS 정보 |
| CNAME(Canonical Name) | •  호스트의 별명(alias) |
| TXT(Text) | • 도메인에 대한 텍스트 정보로 다양한 용도로 활용한다. 
- SPF 레코드(발송자 메인서버 인증) 설정
-  DKIM을 사용하여 디지털 이메일 서명 추가
- DMARC를 사용하여 발신 스팸 방지 |
| PTR(Pointer) | • Reverse Zone 파일에 설정하는 레코드로 A 레코드와는 반대로 IP에 대한 도메인 정보를 담고 있다.  |

#### 재귀적 질의에 대한 제한

- 악의적인 공격자에 의해 과도한 재귀적 질의 요청이 발생하면 DoS 형태의 공격으로 악용될 소지가 있으며 DNS Cache Poisoning 공격에 노출될 수 있다.
- 제한된 사용자가 재귀적 질의 목적으로 사용하는 DNS 서버(Recursive DNS)라면(e.g 사내 DNS 서버) 재귀적 질의에 대한 적절한 점근 제어를 해 줄 필요가 있다.
- 재귀적 질의 접근 제어 설정(/etc/named.conf)
- DNS 서버 기본 설정은 모든 IP에 대해서 재귀적 질의를 허용한다. 따라서 별도로 제어하기 위해서는 allow-recursion을 이용하여 설정한다. 
- allow-recursion을 none으로 설정하거나 recursion no로 설정하면 재귀적 질의를 허용하지 않는다. 
- allow-recursion에 재귀적 질의를 사용할 IP 또는 IP 대역을 명시하여 제한적으로 질의를 허용한다. 
- 별도의 acl(access control list)을 정의하고 allow-recursion에 acl명을 명시하여 제한적으로 질의를 허용한다. 
  
~~- nslookup 명령을 통해 재귀적 질의 수행 결과를 보면 재귀적 질의 제한 시 질의한 도메인(www.google.com)을 찾을 수 없다는 응답이 반환된다.~~

### 존 전송(Zone Transfer)에 대한 제한

- 존 전송에 제한이 없으면 악의적인 공격자에 의해 DoS 공격으로 악용될 수 있다. 즉 지속해서 존 전송을 요청하여 네트워크 및 시스템 자원을 소모시킬 수 있다. 또한 Zone데이터에 저장된 해당 도메인의 서버 정보가 그대로 노출될 수 있다.
- Master DNS 서버만 운영할 경우에는 존 전송을 허용하지 않고, Master와 Slave를 운영하는 환경에서는 지정한 Slave에서만 존 전송을 요청하도록 설정해야 한다.
- 존 전송을 허용하지 않을 경우   
  : named.conf 파일의 allow-transfer를 none으로 설정한다.
- 존 전송을 Slave만 허용할 경우   
  named.conf 파일의 allow-transfer에 Slave의 주소정보를 설정한다.
- dig 명령의 axfr/ixfr 질의 유형을 통해 존 전송 허용 여부를 테스트할 수 있다.


