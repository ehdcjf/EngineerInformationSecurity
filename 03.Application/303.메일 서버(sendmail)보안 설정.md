# 이메일 보안
# 메일서버 보안 설정

<!-- SMTP 오픈 릴레이 동작 방식 이미지 -->

* SMTP 릴레이란 메일 서버 외부에서 메일 서버를 경유하여 다른 메일서버로 메일을 발송하는 것을 말한다. 이때 경유한 메일 서버를 SMTP 릴레이 서버라고 한다. 
* SMTP 릴레이 서버의 발신자 인증 여부에 따라 오픈 릴레이 서버와 인증된 릴레이 서버로 구분할 수 있다. 오픈 릴레이 서버는 발신자에 대한 IP나 메일계정에 대한 인증 없이 모든 메일을 릴레이해주는 메일서버로 인증을 수행하지 않기 때문에 스팸(피싱, 해킹, 바이러스) 메일 발신자의 메일서버로 악용되는 사례가 흔히 발생한다. 따라서 다음과 같은 적절한 설정을 통해 인증된 메일 릴레이가 될 수 있도록 하는 것이 보안상 매우 중요하다. 
  * 허가된 IP 또는 IP 대역, 도메인 등에서만 메일 릴레이가 가능하도록 발신자를 제한한다. 
  *  SMTP AUTH 기능을 사용하여 발신자 계정 인증을 수행한다. 


## sednmail 서버 스팸메일 및 릴레이 차단 설정
* sendmail 은 인터넷 전자메일의 표준규약인 SMTP 프로토콜을 통해서 메일서버 간에 메일을 주고받는 역할을 하는 무료 오픈소스 소프트웨어를 말한다. 
* sendmail 8.9버전 이후부터 스팸차단과 관련된 기능이 추가되었으며 access DB라는 데이터베이스를 이용해 특정 메일의 차단 및 릴레이 제한을 설정할 수 있다. 

### sendmail 관련 주요 디렉터리(리눅스)

|디렉터리|설명|
|----|-----|
|/usr/sbin/sendmail|sendmail 주 데몬 실행 파일|
|/usr/sbin/makemap|sendmail 맵 생성 실행파일(access, virtusertable 등의 db 파일 생성)|
|/usr/spool/mqueue|메일 큐 디렉터리(수신한 메일을 임시 저장)|
|/usr/sbin/mail|개별 사용자 메일함|
|/usr/sbin/access|스팸메일 및 릴레이 차단을 위한 설정파일<br> access 파일은 설정을 위한 텍스트 파일로 실제 정책을 적용하기 위해서는 `makemap` 명령을 이용하여 `access.db 파일`을 생성해야 한다. |
|/etc/mail/sendmail.cf|sendmail 설정 파일|

### access 파일 설정
access 파일 형식: __적용 대상 지정__  __처리 방식 지정__
* 적용 대상 지정: IP, IP 대역, 도메인, 메일주소 등을 지정할 수 있다. 
* 처리 방식 지정

|처리 방식| 의미|
|--------|-----|
|OK|지정한 대상의 메일 조건 없이 모두 허용한다|
|RELAY|지정한 대상의 메일 릴레이를 허용한다<br> sendmail 기본 설정은 로컬호스트를 제외하고는 릴레이를 허용하지 않기 때문에 릴레이가 필요한 사용자 호스트 또는 서버의 IP, IP대역, 도메인 등에 대한 릴레이 허용 설정이 필요하다|
|REJECT|지정한 대상의 메일을 모두 거부한다.(거부 메시지를 보냄)|
|DISCARD|지정한 대상의 메일 모두 폐기한다.(폐기에 대한 메시지를 보내지 않음)<br> 폐기에 대한 메시지를 보내지 않기 때문에 발신자는 발신된 것으로 인식한다|
|501 "message"|지정한 메일주소(발신자/수신자)와 일치할 경우 메일을 거부하고 설정한 거부 메시지를 보낸다.|




### 설정 예시

### access 파일 적용
* access 파일은 정책 설정을 위한 텍스트 파일로 이를 실제 적용하기 위해서는 makemap 명령을 이용하여 access.db 데이터베이스 파일을 생성해야한다.
* `makemap hash /etc/mail/access < /etc/mail/access`
* `makemap hash /etc/mail/access.db < /etc/mail/access`













