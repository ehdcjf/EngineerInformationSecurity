# SQL 인젝션 취약점
* 웹 애플리케이션에서 입력받아 데이터베이스로 전달하는 정상적인 SQL 질의를 변조, 삽입하여 불법로그인, DB데이터 열람, 시스템 명령 실행등을 수행하여 비정상적인 데이터베이스 접근을 시도하는 공격기법
* 조작한 입력으로 데이터베이스 인증 절차 없이 접근 및 자료를 무단 유출하거나 변조할 수 있음
  * DB에 악성 스크립트를 삽입하여 접근하는 사용자를 피싱 사이트 또는 악성 코드 유포사이드로 유도
  * Stored Procedure를 통한 OS 명령 실행
  * DB에 있는 개인정보 획득
* 무료 SQL Injection 취약점 스캐너
  * Nito: GNU 기반 오픈소스로 웹서버 및 SQL Injection에 대한 취약점 점검
  * SQLMap: 블라인드 SQL Injection을 자동으로 수행하는 도구로 python에서 개발
  * Absinthe: GUI 기반의 도구로 블라인트 SQL Injection 취약점에 이용, 데이터베이스 스키마와 목록을 자동화 과정으로 다운로드함. 

## 공격 방식에 의한 분류

### Form SQL Injection
* HTML Form 기반 인증을 담당하는 애플리케이션의 취약점이 있는 경우 사용자 인증을 위한 질의문 조건을 임의로 조작하여 인증을 우회하는 기법. 
* 질의문의 조건절(where절)이 항상 참이되도록 질의문 조작   
  * ` or 1=1#`, `or '1'='1'#`, `or 'a'='a'#`,` or 1=1--` 등 조건절을 무조건 참으로 만드는 입력값 삽입
* 공격이 성공하는 경우, 반환되는 레코드 셋의 첫번째 레코드에 해당하는 사용자 권한을 획득하게 된다. 

#### 대응방법
* 파라미터 필터링
* 선처리 질의문 사용
  * 일반 질의문은 데이터베이스에 요청할 때마다 질의를 컴파일하여 생성한 후 실행하는 방식으로 성능상의 문제 및 사용자 입력값 조작에 따라 의조하지 않는 질의가 생성되어 실행될 가능성이 있다. 
  * 선처리 질의문은 외부로부터 입력값을 제외한 질의부분을 미리 컴파일하여 생성한 후 반복적으로 입력값만을 매개변수로 전달하여 질의문을 실행한다. 
  * 따라서 선처리 질의문은 반복적인 컴파일을 수행하지 않고 사전에 미리 컴파일된 질의문을 사용하기 때문에 성능상의 장점과 함께 공격자가 악의적인 입력값을 삽입하더라도 매개변수로 바인드할 뿐 질의문 자체는 영향받이 않아 SQL 인젝션 공격을 방어하는 효과가 있다. 


### Union SQL Injection
* union select 질의를 이용하여 질의의 경과를 다른 질의의 결과에 결합하여 공격하는 기법
* union 문은 2개 이상의 select문을 결합하고자 할 때 사용하며 이 때 주의할 점은 각각의 select문의 필드 개수가 같아야 하며 필드 타입이 호환되어야 한다. 
  * union all: 단순히 2개 이상의 select문 질의 결과를 합해서(중복포함) 보여준다. 
  * 일반 union: 2개 이상의 select문 질의 결과에서 중복을 제거하고 보여준다. 

#### 컬럼 개수 파악하기
* union select 문을 성공적으로 수행하기 위해서는 먼저 선행 select문과 후행 select문의 컬럼 개수가 일치해야한다. 따라서 선행 select문의 컬럼 개수를 파악하는 것이 우선된다. 
* 컬럼 개수를 파악은 2가지 방법을 이용할 수 있다. 
  * order by절에 컬럼 인덱스를 지정할 수 있는데 지정한 인덱스의 컬럼이 없으면 오류가 발생한다는 점을 이용하여 컬럼 개수를 확인한다. 
  * union select 문을 이용하면서 컬럼 개수가 맞지 않으면 오류가 발생한다는 특성을 이용하여 컬럼 개수를 확인한다. 

### Stored Procedure SQL Injection
* 저장된 프로시저는 일련의 질의를 마치 하나의 함수처럼 실행하기 위한 질의의 집합이다. 
* `;` 세미콜론 문자를 통해 명령어를 연속 수행시키면서 `xp_dirtree` 확장 프로시저를 실행 하여 `c:\`의 파일목록을 확인한다. 
*`;` 세미콜론 문자를 통해 명령어를 연속 수행시키면서 `xp_rewrite` 확장 프로시저를 통해 공격자가 심어놓은 악성 코드를 실행시킨다. 


### Mass SQL Injection
* 기존 SQL 인젝션의 확장된 개념으로 한번의 공격으로 대량의 DB 값이 변조되어 홈페이지에 치명적인 영향을 미치는 공격
* DB값 변조 시 악성 스크립트를 삽입하여 사용자가 변조된 사이트 방문 시 감염되거나 악성 Bot이 설치된다. 
* 악성 스크립트는 보통 js, swf, exe 파일을 이용

## 공격 유형에 대한 분류

### Error-Based SQL Injection
* DB 질의에 대한 에러값을 기반으로 한 단계씩 점진적으로 DB 정보를 획득하는 방법이다. 클라이언트에서 조작할 수 있는 파라미터에 SQL 질의 관련 특수문자를 삽입하여 SQL 에러가 발생하면 해당 취약점이 있다고 판단할 수 있다. 
* DB 질의에 대한 에러가 외부로 노출되는 취약점을 이용한 공격이다. 
* 최근에는 웹서버 보안 강화로 인하여 에러 값을 노출하는 경우가 많지 않지만, 과거에는 많이 발견되었던 공격 유형이다. 

### Blind SQL Injection
* DB 질의에 대한 오류 메시지를 반환하지 않으면 공격할 수 없는 Error-Based SQL 인젝션과 달리 오류 메시지가 아닌 질의 결과의 참과 거짓을 통해 의도하지 않는 SQL문을 실행함으로써 데이터베이스를 비정상적으로 공격하는 기법이다. 
* 단순하게 오류 메시지를 자세하게 반환하지 않게 설저해놓았다면 Error-Based SQL 인젝션은 피할 수 있지만 Blind SQL 인젝션에는 취약하다. 
* 질의 경과의 참/거짓에 대한 반응 형태에 대한 파악이 우선되며, Error-Based SQL 인젝션에 비해 많은 비교과정을 거치기 때문에 취약점 발견시 자동화 도구를 이용하는 것이 일반적이다. 

