# 이메일 보안
# 이메일 인증 기술(스팸메일 방지 기술)

## SPF(Sender Policy Framework)
<!-- ### SPF 동작방식 이미지 -->
* 발신 메일서버 정보를 사전에 발신 도메인 DNS 서버에 공개적으로 등록하여 수신자가 수신한 메일의 발신자 IP 주소가 발신자 메일주소 도메인(MAIL FROM 정보)의 실제 메일 서버 정보(IP주소)와 일치하는지 검사할 수 있도록 하는 이메일 인증 기술
  * `발송자 메일 서버 인증` 또는 `메일서버 등록제` 라고 표현한다.
* 대다수 스팸(해킹) 메일 발송자가 자신의 신원을 감추기 위해 발신자 메일주소를 조작하는 경우가 많으므로 이점에 착안하여 만든 인증 기술이다. 

### 동작방식
1. (발신측) 발신자 도메인의 DNS 서버에 해당 도메인에서 사용하는 발신자 메일서버 정보(IP 정보)와 수신 측 처리방식을 담고 있는 SPF 레코드 정보를 도메인의 TXT 레코드에 기록하여 등록한다. 

2. (수신측) 수신자 메일서버는 발신자 메일주소 도메인에 대한 SPF 레코드를 조회(TXT 레코드 질의)한 후 실제 메일을 발송한 메일서버의 IP가 조회한 SPF레코드에 등록된 서버인지 여부와 처리방식에 따라 수신여부를 결정한다. 


### SPF 레코드 형식
* SPF 레코드는 버전과 하나 이상의 한정자와 메커니즘의 조합으로 이루어진 텍스트이다. 

|구분|값|설명|
|---|---|---|
|버전<br>(Version)|v=spf1|spf 레코드 버전|
|한정자<br>(Qualifier)|+,-,<br>~,?|메커니즘과 함께 사용되며, 수신측에서 메커니즘 값과 일치할 경우 어떻게 처리할지를(인증 통과, 실패 등) 알려주는 역할을 한다.|
|메커니즘|ip4, ip6, include, all 등|발신 메일 서버의 매칭 방식을 정의하며 순서대로 매칭 여부를 판단한다<br> ip4/ip6: IPv4/IPv6 주소 또는 주소 범위를 지정<br>include: 지정한 도메인에 있는 SPF 레코드 정보를 참조 <br>all:모든 주소를 의미, 일반적으로 레코드의 가장 마지막에 위치하여 이전 메커니즘에 일치하지 않는 나머지 모든 주소를 의미하게 된다|


#### 한정자 종류
* `+`: 인증 통과. 메커니즘과 일치할 경우 인증된 메일서버로 메일을 통과시키라는 의미 (기본값)
* `-`: 인증 실패 또는 심각한 인증 실패. 메커니즘과 일치할 경우 인증되지 않는 메일서버로 메일을 거부(차단)하라는 의미이다. 일반적으로 수신측 메일서버에서 스팸 메일함에 임시 보관하거나 수신을 거부한다. 
* `~`: 가벼운 인증 실패. 메커니즘과 일치할 경우 인증되지 않는 메일서버로 수신 측 메일서버 정책에 따라 허용 여부를 판단하라는 의미이다. 일반적으로 메일 수신이 허용되거나(의심스러운 메로 표시) 거부될 수 있따. 
* `?`: 중립. 메커니즘과 일치할 경우 인증 여부에 대한 판단정보가 없음을 의미한다. 





## DKIM(DomainKeys Identified Mail) 기술
* 발신자가 발신 메일의 메시지 헤더와 바디에 대한 디지털 서명을 메일 헤더에 삽입하여 수신된 이메일이 위변조되지 않았는지 수신자 측에서 검증할 수 있는 이메일 인증 기술이다. 
* "도메인 키 인증메일" 이라고 표현한다.
  

### 동작방식
1.  (발신측) 발신자 도메인의 DNS서버에 수신측에서 디지털서명을 검증할 수 있는 정보(서명 알고리즘, 공개키)를 담고 있는 DKIM 레코드 정보를 지정한 도메인의 TXT레코드에 기록하여 등록한다. 
    * DKIM 레코드 형식
  
	|구분|값|설명|
	|---|--|---|
	|버전|v=DKIM1|DKIM 레코드 버전|
	|알고리즘|k=rsa등|DKIM 인증 시 사용할 디지털 서명 알고리즘|
	|공개키|p=문자열|디지털 서명 검증 시 사용하는 공개키로 Base64로 인코딩한 문자열을 사용한다.|

2. (발신측)발신자 메일서버에서 발실 메일의 메시지 헤더와 바디를 개인키로 서명한 후 서명값을 DKIM-Signature에 추가하여 전송한다. 
3. (수신측) 수신자 메일서버는 DKIM-Signature 헤더에 있는 정보를 참조하여 공개된 지정한 domainkey 도메인에 대한 DKIM 레코드를 조회한 후 DKIM 레코드에 등록된 공개키와 서명 알고리즘을 이용하여 DKIM-Signature 헤더에 있는 서명값 검증을 수행한다. 
	* DKIM Signature 형식

	|태그형식|설명|
	|:-------:|----|
	|v|DKIM-Signature 버전|
	|a|DKIM 인증 시 사용할 디지털 서명 알고리즘<br> a=rsa-sha256: 서명 대상 데이터를 sha256으로 해시한 후 해시값을 rsa 알고리즘으로 디지털 서명|
	|h|서명 대상 메시지 헤더 리스트|
	|bh|메시지 바디의 데이터를 서명한 서명값|
	|b|h태그에 명시한 헤더의 데이터를 서명한 서명값|

  
## DMARC(Domain-based Message Authentication, Reporting and Conformance)
* SPF 인증 기술과 DKIM 인증기술을 DMARC 인증 정책을 통해 모두 적용하여 정당한(인증된) 발신자인지 여부와 메일의 위변조 여부를 검사하고 수신측에서 정책 처리 결과(인증실패)에 대한 DMARC 보고서를 발신 측에 전달하여 발신 측에서 메일 모니터링을 할 수 있는 이메일 인증 기술이다. 
* "도메인 기반 이메일 인증" 이라고 한다. 


## 동작방식
1. (발신측) 발신측 도메인의 DNS 서버에 SPF 레코드와 DKIM 레코드를 우선적으로 등록하고 인증 정책 정보를 담고 있는 DMARC 레코드 정보를 DMARC 용도의 도메인의 TXT 레코드에 기록하여 등록한다. 

2. (수신측) 수신자 메일서버는 SPF, DKIM 및 DMARC 레코드를 조회하고 DMARC 정책에 따라 인증을 수행한다. 인증에 실패한 메일에 대해서는 DMARC 보고서를 작성하여 발신측에 전송한다. 


## 인증 기술 관련 주요 메일 헤더 정보
### Received 메시지 헤더
* 실제 메일이 전송된 경로를 나타낸다. Received 헤더가 여러 개인 경우는 여러 메일서버(MTA)를 경유했다는 의미이며 가장 아래쪽에 보이는 헤더가 처음 메일을 발송한 메일 서버이고 위로 올라갈수록 거쳐 온 메일서버를 보여준다. 
* Received 메시지 헤더는 메일서버(MTA)를 경유할 때마다 추가되는 헤더로 일반적으로 스팸 메일 분석 시 발송 근원지를 역추적하기 위해 참고하는 중요한 정보이다. 

* 형식
  > __Received__: "__from__ 발송호스트" "__by__ 수신 호스트" "__id__ 고유식별자" <br> "__for__ 수신자 메일주소" "수신 날짜/시간"

* 통신 구간 보안을 위해 SSL/TLS를 지원하는 SMPTS를 적용한 경우에는 관련 정보를 확인할 수 있다. 

* Received 헤더 TLS Cipher Suite 표기 
  |키교환 <br>알고리즘| 인증/서명 <br>알고리즘||대칭키 블록 <br>암호 알고리즘|블록암호<br>운용모드|메시지인증(MAC)<br>알고리즘|
  |:--:|:--:|:--:|:--:|:--:|:--:|
  |||||||

### Received-SRF 메시지 헤더
* 수신자 메일 서버에서 SPF 인증 경과를 기록하는 헤더이다. SPF 인증 경과는 Authentication-Result 헤더에서도 확인할 수 있다. 

### Authentication-Results 메시지 헤더
* 수신 메일 섭에서 SPF, DKIM, DMARC 인증 결과를 기록하는 헤더이다. 인증 기술에 따라 pass, fail 등의 값으로 기록한다. 


## 이메일 인증을 위한 기술적 대응방안
* 신뢰할 수 있는 발신자로 사칭하는 스팸(피싱, 해킹 등) 메일에 대응하기 위해서는 SPF(Sender Policy Framework, 메일 서버 등록제) 인증기술을 통해 인증된 발신자 메일서버로부터 온 메일인지 확인하고, DKIM(DomainKeys Identified Mail, 도메인 키 인증메일) 인증 기술을 통해 메일의 헤더나 내용이 위변조되지 않았는지 확인하는 한편, DMARC(Domain-based Message Authentication Reporting & Conformance, 도메인 기반 이메일 인증) 인증 기술로 정책에 따른 SPF와 DKIM의 이중 적용 및 수신이 실패되는 일에 대한 모니터링이 필요하다. 
















