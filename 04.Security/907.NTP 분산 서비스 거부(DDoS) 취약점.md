# NTP 분산 서비스 거부(DDoS) 취약점 
* NTP(Network Time Protocol)는 네트워크를 통해 컴퓨터 시스템 간 시간 동기화를 위해 사용하는 인터넷 프로토콜로 123/udp 포트를 서비스 포트로 사용한다. 
* NTP 분산 서비스 거부 취약점(CVE-2013-5211)은 NTP 서버의 특정 명령어`monlist`를 이용하여 대규모 증폭, 반사 형태의 디도스 공격을 유발시킬 수 있는 취약점으로 전 세계적으로 대규모 디도스 공격을 위한 새로운 위협이 되고 있다. 
  * 2014년 2월 미국의 보안업체 클라우드플레어의 고객사를 대상으로 NTP 취약점을 이용한 400Gbps의 대규모 디도스 공격이 발생한 사례가 있으며 국내에서도 동일한 기법의 디도스 공격이 발견되고 있다. 

## 날짜/시간 관련 주요 유닉스/리눅스 명령어

### `date`
* `date`:  현재 서버의 날짜/시간 확인 
* `date MMDDhhmmCCYY.ss`:  현재 서버의 날짜/시간 설정(MM(월), DD(일), hh(시), mm(분), CC(년도 앞 2자리), YY(년도 뒤 2자리), ss(초))

### `rdate`
* 원격지의 타임 서버를 이용하여 날짜 및 시간 정보를 확인하거나 현재 서버에 설정할 수 있는 명령어
* 타임 서버는 타임 프로토콜을 이용하여 날짜/시간 정보를 제공해주는 서버이고, 타임 프로토콜은 31/tcp,udp 포트를 이용하여 날짜/시간 정보를 제공해주는 인터넷 프로토콜이다. 과거 유닉스 계열 시스템에서 날짜/시간 동기화를 위해 주로 사용하던 프로토콜로 현재는 시간 정밀도가 높은 NTP 프로토콜로 대체되고 있다. 
* `rdate -p 타임서버`:  타임서버의 날짜/시간 정보를 확인
* `rdate -s 타임서버`:  타임서버의 날짜/시간 정보를 현재 서버에 설정

### `ntpdate` 
* 원격지의 NTP 서버를 이용하여 날짜 및 시간 정보를 확인하거나 현재 서버에 설정할 수 있는 명령어
* `ntpdate -q NTP서버`: NTP서버의 날짜/시간 정보를 확인
* `ntpdate NTP서버`: NTP서버의 날짜/시간 정보를 현재 서버에 설정



### NTP `monlist` 명령어
* NTP 서비스 데몬(ntpd)은 질의를 통해 해당 서비스 데몬에 접속한 호스트를 모니터링할 수 있는 기능을 지원한다. `monlist` 라는 이름의 명령어로 NTP 데몬에 질의를 요청하면 최근 접속한 600개의 접속 호스트 리스트를 받을 수 있다. 
* `ntpdc -n -c monlist <점검 대상 NTP 서버>`

  | 문법 | ntpdc -n -c monlist <점검 대상 NTP 서버>|
  | ---- |    --------------------------------------------------------------------------------- |
  | 옵션 | `-n` 응답 결과의 호스트 주소를 숫자 형식으로 출력할 때 사용  <br> `-c` 질의할 명령어(monlist) 지정|
  | 점검 대상 NTP 서버 | IP 주소 또는 도메인 명 지정|
  | 설명 |ntpdc는 NTP 서버 질의용 프로그램으로 -c 옵션으로 monlist 명령어를 지정한 후 대상 NTP 서버로 질의하면 대상 NTP 서버에 최근 접속한 호스트 목록을 최대 600개까지 받을 수 있다 |

### 공격원리
1. 변조(스푸핑):공격자는 출발지 IP 주소를 공격대상 서버의 IP로 패킷 변조한다. 
2. 전송: 취약한 다수의 NTP 서버를 대상으로 monlist 명령의 다수 질의를 전송한다. 
3. 증폭 및 반사: 질의를 수신한 NTP 서버는 다수의 접속 호스트 정보를 담은 증폭된 결과를 변조된 출발지은 공격 대상 서버로 응답한다. 
4. 장애: 공격 대상 서비스는 증폭된 다수의 응답 수신으로 네트워크 대역이 소진되어 서비스 거부 상태가 된다. 


### 대응방안
1. 취약한 NTP 데몬(ntpd) 서버 버전을 업그레이트 한다. 
2. 서비스 운영상 버전 업그레이드가 어려운 경우  설정 변경을 통해 monlist 기능을 해제한다. 
  *  ntpd 설정파일(ntp.conf)에 `disable monitor`를 추가하여 monlist 기능을 해제하도록 설정한 후 ntpd 데몬을 재시작한다. 
3. 보안장비(방화벽 등)를 통한 차단. 
  * 일반적인 NTP 서버 응답 패킷은 100byte이하(48byte)이고 monlist 질의를 통한 응답 패킷은 400byte 내외로 발생하므로 패킷 크기를 이용하여 접근을 차단한다. 
  * `iptable -A OUTPUT -p udp --sport 123 -m length --length 100: -j DROP`
    * 응답패킷이므로 OUTPUT 체인 설정 (-A OUTPUT)
    * NTP 프로토콜은 UDP 프로토콜(-p udp)을 사용하고 NTP 서버의 응답 패킷이므로 출발지 포트를 123번 포트(--sport 123)로 설정
    * 100byte 이상의 응답 패킷(-m length --length 100:)을 차단하도록(-j DROP) 설정


