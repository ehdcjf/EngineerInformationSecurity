# UNIX/Linux 시스템 기본

### 시스템 접근
##### 로그인
1. 사용자 계정과 패스워드를 입력하면 로그인을 담당하는 프로그램은 입력한 패스워드와 /etc/passwd 파일의 해당 필드를 비교한다. 
2. 패스워드 확인 후 로그인 프로그램은 쉘이 사용할 변수들을 근거로 초기 환경을 설정한다. 
      * HOME: 사용자 홈디렉터리 지정
      * SHELL: 로그인 쉘 지정
      * USER 또는 LOGNAME:  사용자의 사용자 계정 지정
3. 모든 절차가 끝나면 로그인 쉘 실행

##### 로그아웃
* 유닉스 시스템에서 로그아웃을 할 때 사용하는 명령어는 `logout` 과 `exit`가 있으며 키보드의 `[Ctrl+d]` 조합키를 사용할 수도 있다. 

### 사용자 정보 
##### etc/passwd 파일
* UNIX는 시스템 관리자가 사용자 계정을 만들 때마다 사용자와 관련된 정보를 /etc/passwd 파일에 저장한다. 
  
|account|password|UID|GID|comment|home directory|login-shell|
|-|-|-|-|-|-|-|
|사용자 계정명|사용자 패스워드(x는 shadow 패스워드를 사용한다는 의미)|사용자 ID|기본그룹 ID|사용자 관련 기타 정보|로그인 성공 후 사용자가 위치할 홈 디렉토리|로그인 쉘|

```bash
$ cat /etc/passwd

root:x:0:0:root:/root:/bin/bash
...
ehdcjf:x:1000:1000:ehdcjf,,,:/home/ehdcjf:/bin/bash
```

* 해킹 시 주로 UID, GID를 0으로 변경한다. 시스템은 UID,GID를 기준으로 권한을 부여하기 때문에 계정 이름이 root 가 아니라도 UID, GID가 0이면 root가 되는 것이다. 이는 윈도우의 보안식별자(SID) 500이 관리자인 것과 같은 개념이다. 
* UID,GID 가 0으로 변경된 계정이 있는지 주기적으로 확인해 취약점을 제거해야한다. 로그인 쉘을 변경하여 사용자 로그인 시 악성 쉘이 실행되게 하는 예도 있으므로 주기적으로 변경 여부를 확인해야한다. 

##### 사용자 확인 `id`
* 접속 중인 사용자를 확인하려면 id 명령을 사용한다. 
```sh
$ id ehdcjf

uid=1000(ehdcjf) gid=1000(ehdcjf) groups=1000(ehdcjf),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),135(lxd),136(sambashare)
```

##### 패스워드 변경 `passwd`
* 사용하던 패스워드를 변경하거나 패스워드가 없는 사용자 계정에 패스워드를 부여할때 passwd 명령을 사용한다. 
* 일반 사용자는 자신의 패스워드만 변경할 수 있지만, 슈퍼 유저root는 자신을 포함하여 시스템에 등록된 모든 사용자의 패스워드를 변경할 수 있게 한다. 



### 그룹정보
##### 그룹명과 그룹ID
* UNIX 시스템은 자원에 대한 접근 권한 및 보안 등의 관리를 위하여 사용자와 사용자가 소속된 그룹에 대한 식별이 필요하다. 
* 사용자 ID와 그룹ID는 사용자와 그룹을 식별하는 식별자로 시스템에 유일한 정수 값으로 기술된다. 
##### 기본 그룹과 보조 그룹
* UNIX 시스템은 자원의 소유자가 소속된 그룹에 별도의 권한을 지정할 수 있는데, 같은 그룹에 소속된 사용자는 자원에 대하여 동일한 접근 권한을 갖는다. 
* UNIX 시스템의 사용자 계정은 하나의 기본 그룹과 복수의 보조그룹에 소속될 수 있다. 
* 기본 그룹은 사용자가 자원(파일 등)생성 시 해당 자원의 소유그룹을 지정하는데 사용되며 /etc/passwd 의 4번째 필드 GID 값에 명시한다. 
  
##### /etc/group 파일
* 현재 시스템에 정의된 모든 그룹의 정보를 저장하고 있다. 

|group_name|unvariable|group_ID|user_account_entry_in_group|
|-|-|-|-|
|그룹명|그룹의 암호화된 패스워드(사용안함)|기본 그룹ID. 그룹명을 대신하는 정수형 숫자| 소속된 사용자 계정들|


### 입출력 재지정 (I/O Redirection)
* 입출력 대상으로 표준 입력, 표준 출력, 표준 예러를 사용하지 않고 다른 경로인 파일로 재지정 하는 것
* 키보드(표준입력:0) 에서 들어오는 입력을 파일에서 받도록 대체하는 것을 입력 재지정이라한다. 

    ```sh
       $ command [0] < file_name
    ```


* 명령의 실행 결과나 에러 상황을 화면(표준출력:1, 표준에러:2)에 출력하지 않고 파일로 대체하는 것을 출력 재지정이라 한다. 

    ```sh
       $ command [1 or 2] > file_name (미지정시 표준출력)

       >  # 출력 재지정(출력 파일 존재 시 새롭게 출력)
       >> # 출력 재지정(출력 파일 존재 시 추가하여 출력)
    ```


### ~~파이프(Pipe)~~

### ~~특수문자~~

# UNIX/Linux 파일 시스템
### 개요
* 물리적 저장장치에 파일 생성, 저장, 관리하기 위한 논리적인 자료구조를 파일시스템이라고 한다. 
* 물리적인 디스크는 논리적인 파티션으로 나누어지며, 파티션 별로 고유한 파일 시스템을 생성한다. 
##### 파일 시스템 구성
1. 부트블럭
    운영체제를 부팅하거나 초기화하기 위한 부트스트랩 코드를 담고 있는 블럭
2. 슈퍼블럭
    해당 파일시스템을 관리하기 위한 정보를 담고 있는 블럭
3. 아이노드 리스트
   
|속성|설명|
|-|-|
|inode number|파일 시스템 내에서 해당 파일을 식별하기 위한 고유 식별자|
|파일 타입|일반 파일, 디렉터리, 장치파일 등 파일 유형|
|접근 권한|파일에 대한 접근권한|
|link count|해당 inode를 참조하는 링크 개수(하드링크 개수)|
|소유자|파일의 소유자/UID|
|소유그룹|파일의 소유그룹/GID|
|파일크기|파일의 크기|
|MAC time|last Access Time: 파일을 마지막으로 접근한 시간<br>last Modification Time: 파일의 내용을 마지막으로 수정한 시간<br>last Change Time:파일의 속성을 마지막으로 변경한 시간. 파일의 속성을 inode정보를 의미. 즉 소유자,접근권한 등의 속성이 변경되면 last Change Time이 변경|
|Block Index|Data blocks에 저장되어 있는 파일의 내용에 대한 색인 정보|
* 아이노드 리스트는 파일들에 대한 속성정보를 담고 있는 inode 구조체 리스트로 이루어져 있다. 
* 각 파일의 속성정보는 위와 같다. 주의할 점은 inode에는 파일명이 없으며 파일 명은 디렉토리를 통해 관리된다. 
* 침해 사고가 발생하면 피해 시스템에 대한 무결성을 확인하기 위해 타임라인을 분석을 수행한다. 이때 파일시스템 inode 구조체의 MAC Time 을 점검한다. 
* 특정 파일의 inode에 대한 속성정보는 stat 명령을 통해 확인할 수 있다. 

4. Data blocks
* 실제 파일의 내용(데이터)이 저장되는 블럭
* 고정 크기의 블럭들로 이루어져 있다. 

### 파일 시스템과 링크 파일 `ln`
##### 개요
* 링크는 윈도우의 바로가기 아이콘 처럼 기존 파일에 대한 또 다른 접근 포인트를 만들어주는 기능이다. 
* 링크는 하드 링크와 심볼릭 링크로 구분할 수 있다. 

|문법| ln [-s] source_file or source_directory target_file |
|-|-|
|옵션| `-s` 이 옵션이 있으면 심볼릭 링크. 없으면 하드 링크|
|설명| 하드 링크는 파일에만 가능하고, 심볼릭 링크는 파일 또는 디렉토리에 링크할 수 있다. |

##### 하드 링크
* 하드 링크는 유닉스 초기 시절부터 지원해주던 방식으로 기존 파일과 동일한 inode number를 가지는 파일을 생성하여 접근하는 방식을 말한다. 
* inode number는 파일 시스템 별로 고유한 값이기 때문에 동일한 파일 시스템 내에서만 하드 링크가 가능하고 디렉터리는 하드 링크가 불가능하다. 
* 하드 링크 파일을 생성하면 해당 inode의 링크 카운트가 1 증가한다. 파일 삭제 시에는 링크 카운트를 1 감소시킨 후 그 값이 0이 되었을 때 해당 파일의 inode 정보 및 데이터가 삭제된다. 즉 inode를 참조하는 파일이 있으면 삭제하지 않는다. 

##### 심볼릭 링크
* 동일한 파일 시스템 내에서만 링크가 가능한 하드 링크의 단점을 보완
* 원본 파일에 대한 파일 경로를 파일 내용으로 하는 새로운 파일을 생성해서 접근하는 방식으로 하드링크와 달리 inode number 가 아닌 파일 경로를 기반으로 하므로 파일시스템에 제한이 없으며 디렉터리도 가능하다. 
* 원본 파일이 삭제되거나 이동하게되면 해당 경로가 바뀌므로 심볼릭 링크 파일은 링크가 끊어지게 된다. 

### 디렉터리 관리
##### 파일의 종류 
1. 일반파일
    일반적으로 데이터 또는 프로그램 코드에 해당하는 일련의 바이트 스트림으로 되어 있다. 이러한 정규 파일은 표준 파일 입출력 시스템 호출을 통해 참조된다. 
2. 디렉터리
    디렉터리에 포함된 파일명과 해당 파일에 대한 정보를 담고 있는 inode number 목록을 내용으로 가지고 있는 특수한 파일로 디렉터리 파일은 디렉터리의 명시적인 시스템 호출(ls)을 통해 참조된다. 
3. 특수 파일
   특수 파일은 기능에 따라서 다양한 형태로 존재하며 표준 입출력 시스템 호출을 통해 참조된다. 
   * 프로세스 간 통신(IPC)를 위해 파이프(pipe), 소켓(socket) 등의 파일을 사용한다. 
   * 디스크, 프린터, 터미널, 키보드 등의 주변장치를 사용하기 위한 장치파일로 블럭 단위로 입출력하는 블록 장치파일(버퍼링)과 문자단위로 입출력하는 문자 장치파일(비 버퍼링)로 구분한다. 
  

##### ls
* 파일의 종류

|문자값|디렉터리 및 파일의 종류|
|-|-|
|d|디렉터리|
|b|블록 장치 파일|
|c|문자 장치 파일|
|l|심볼릭 링크 파일|
|p|네임드 파이프|
|s|유닉스 도메인 소켓|
|-|일반(정규) 파일|

##### ~~cd~~
##### ~~mkdir~~
##### ~~rmdir~~


# UNIX/Linux 파일 관리
### ~~접근 권한 변경 `chmod`~~
### ~~소유주/소유그룹 변경 `chown`/`chgrp`)~~
### 접근 권한 마스크`umask`
* umask 명령은 앞으로 만들어질 파일에 영향을 미치는 명령으로, 명령 시 지정한 8진수는 새로 만들어질 파일에서 제거될 권한을 명시한다. 
* 일반 파일을 생성할 때 접근권한은 666에서 umask 로 지정한 값을 빼고, 디렉터리의 경우 777에서 umask 로 지정한 값을 빼게 된다. 
* 시스템 관리자는 /etc/profile 파일에 umask를 지정하여 시스템 전체 사용자에게 획일적인 umask 값을 적용할 수 있다. 

### ~~UNIX/Linux 파일 검색 `find`~~


# UNIX/Linux 프로세스
### 프로세스 개요
* 프로세스가 생성되면 커널/운영체제는 개
### 프로세스 기본 조건
### 프로세스 실행 과정
### 프로세스 관련 식별자
### 프로세스 정보 확인 (ps)
### 프로세스간 통신(시그널)

# UNIX/Linux 시스템 관리

### 부팅 관련 용어 정리

##### 런 레벨

##### INIT 상태

##### 시스템 런 레벨 단계 구성

### 시스템 시작
1. 바이오스 과정
2. 부트 프로그램 과정
3. 커널 과정
4. init 프로세스 과정

### 시스템 종료

### 사용자 관리
##### 사용자 계정 추가
##### 사용자 계정 삭제
##### 그룹 추가
##### 그룹 삭제

### 파일 시스템 관리
##### 파일시스템 연결 (mount)
##### 파일시스템 연결 해제 (unmount)
##### 하드 디스크 사용량 (du)
##### 파일 시스템 용량 정보(df)

### 정기적 스케줄 관리 cron
##### cron
##### crontab 파일의 구조
##### crontab 파일의 제어
##### crontab 명령 접근제어

### 일시적 스케줄 관리 at





# UNIX/Linux 서버 시스템 보안
### 사용자 패스워드 관리
##### passwd
##### shadow

### 프로세스 실행 권한(SUID, SGID)
##### RUID, RGID. EUID, EGID
##### SUID, SGID
##### 특수 권한 비트

### 디렉터리 접근 권한(sticky-bit)

# UNIX/Linux 서버 네트워크 보안
### SSH

### 슈퍼 서버 [inetd 데몬]
##### 개요
##### inetd.conf 파일 구조
##### 불필요한/취약한 서비스 비활성화

### 접근통제[TCP Wrapper]
##### 개요
##### host.allow host.deny

#### xinetd 슈퍼데몬
##### 개요
##### 설정 파일 형식 (일반설정)
##### 설정 파일 형식 (접근제어 관련 설정)
##### 설정 파일 형식 (로그 관련 설정)

# PAM(장착형 인증 모듈 Pluggable Authentication Modules)
### 개요
### PAM을 사용한 인증 절차
### PAM 설정파일
### PAM 활용 예1
### PAM 활용 예2
### PAM 활용 예3

# 시스템 로그 설정과 관리
### 개요
### 유닉스/리눅스 주요 로그 파일
##### utmp(x) 로그 파일 
##### wtmp(x) 로그 파일 
##### lastlog 로그 파일
##### btmp(Linux),loginlog(Unix(SunOS)) 로그 파일
##### sulog 로그 파일 (Unix(SunOS))
##### acct/pacct 로그 파일 (Linux/Unix(SunOS))
##### histroy 로그 파일 (Linux/Unix(SunOS))
##### secure 로그 파일(Linux)
##### messages 로그 파일(Linux)
##### dmesg 로그 파일(Linux)
##### boot.log 로그 파일(Linux)
##### xferlog 로그 파일(Linux)
##### cron 로그 파일 (Linux)
##### maillog 로그 파일 (Linux)

### syslog 설정 및 관리
##### 개요
##### facility: 로그 생성 서비스
##### priority: 로그 수준
##### action 
##### syslog.conf

### 리눅스 로그 관리
##### 로그 모니터링
##### 로그 파일 순환(rotate) 관리


# UNIX/Linux 서버 취약점

### UNIX/Linux 서버 계정 관리
1. root 이외의 UID가 0 금지
   *  root(UID=0)와 동일한 UID를 가진 계정 존재 시 root 권한으로 시스템 접근이 가능하므로 root의 UID를 가진 계정이 존재하지 않도록 확인
   *  root 이외의 계정이 UID=0 인 경우 0이 아닌 적절한 UID를 부여하거나 불필요한 계정일 경우 삭제
  
    |OS|명령어|
    |---|---|
    |SOLARIS,<br>LINUX,<br>HP-UX|usermod -u 2023 ehdcjf|
    |AIX|chuser id=2023 ehdcjf|

<br>

2. 패스워드 복잡성 설정
    * 사용자 계정 암호를 유추하기 쉽게 설정하면 비인가자의 시스템 접근을 허용하게 하는 위험이 존재한다. 
    * 패스워드 관리 방법
        1. 영문, 숫자, 특수문자를 조합하여 계정명과 상이한 8자 이상의 패스워드를 설정한다. 
        2. 영문 대문자, 영문 소문자, 숫자, 특수문자 중 2종류 이상을 조합하여 최소 10자리 이상 또는 3종류 이상을 조합하여 최소 8자리 이상의 길이로 구성한다. 
        3. 시스템마다 상이한 패스워드를 사용하고 패스워드를 기록할 경우에는 변형하여 기록한다. 
        4. 가급적이면 자주 패스워드를 변경한다. 
<br>

3. 패스워드 최소 길이 설정
    * 패스워드 무차별 공격이나 패스워드 추측 공격에 대응하기 위해 패스워드 최소 길이 설정이 필요하다. 최소 8자 이상. 

<br>

4. 패스워드 최대 사용기간 설정
    * 패스워드 최대 사용기간을 설정하지 않으면 일정 기간 경과 후에도 유출된 패스워드로 접속할 수 있다. 
    * 악의적인 사용자의 계속된 접속을 차단하기 위해 패스워드 최대 사용기간을 설정하여 주기적으로 변경할 수 있도록 한다. 
    * 최대 사용 기간을 90일(12주)로 설정한다. 

<br>

5. 패스워드 최소 사용기간 설정
    * 패스워드 최소 사용기간을 설정하지 않으면 사용자에게 익숙한 패스워드로 쉽게 변경할 수 있으며 이를 재사용함으로써 패스워드의 정기적 변경은 무의미해질 수 있다. 
    * 패스워드 최소 사용기간을 1일(1주)로 설정한다. 
  
<br>

6. 패스워드 파일 보호
    * 패스워드 정보를 평문으로 저장하는 경우 정보 유출 피해가 발생할 수 있으므로 패스워드를 암호화하여 보호해야한다. 
    * shadow 패스워드를 사용하여 "/etc/shadow" 파일에 암호화된 패스워드가 저장되도록 하고 권한이 있는 사용자들만 읽을 수 있도록 제한한다. 

<br>

7. Session Timeout 설정
    * 계정이 접속된 상태로 방치되면 권한이 없는 사용자에게 중요한 시스템이 노출되어 악의적인 목적으로 사용될 수 있으므로 일정 시간 이후 어떠한 이벤트가 발생하지 않으면 연결을 종료하는 Session Timeout 설정이 필요하다. 
<br>


### 파일 및 디렉터리 관리
1. root HOME, PATH 디렉터리 권한 및 PATH 설정
    * root 계정의 PATH 환경변수에 "."이 포함되어 있으면 root 계정으로 접속한 관리자가 의도하지 않은 현재 디렉터리에 위치하고 있는 명령어가 실행될 수 있다. 즉 "."이 /usr/bin, /sbin 등의 명령어들이 위치하고 있는 디렉터리보다 우선하여 위치하고 있을 경우, root 계정으로 접속한 관리자가 특정 명령을 실행하면 불법적으로 현재 디렉터리에 위치시킨 파일을 실행하여 예기치 않은 결과를 가져올 수 있다. 
    * PATH 환경 변수에 "."이 맨 앞 또는 중간에 위치하고 있으면 root 가 의도하지 않은 명령이 실행될 수 있으므로 PATH 환경변수의 마지막으로 이동시키거나 불필요한 경우 삭제한다. 
<br>

2. 파일 및 디렉터리 소유자/소유그룹 설정
   * 소유자/소유그룹이 존재하지 않는 파일 및 디렉터리는 현재 없는 소유자/소유그룹의 소유였거나, 관리 소홀로 인해 생긴 파일일 가능성이 있다. 
   * 사용하지 않는 디렉터리나 파일일 경우 시스템 자원 낭비가 될 수 있고 중요한 파일 및 디렉터리일 경우 관리가 되지 않는 문제가 있다. 
    * find 명령의 -nouser -nogroup 옵션을 통해 소유자/소유자그룹이 존재하지 않는 파일/디렉터리를 검색
    ```sh
        $ find .\( -nouser -o -nogroup \) -exec ls -al {} \;
    ```

    * 파일 소유자/소유그룹 변경 또는 불필요 시 삭제
        chown 또는 chgrp 명령을 통해 소유자/소유그룹을 변경한다. 

3. world writable 파일 점검
    * "world writable" 파일이란 모든 사용자(others)에게 쓰기 권한이 부여된 파일을 말한다. 
    * 모든 사용자가 접근 및 수정할 수 있는 권한으로 설정된 파일이 존재하면 일반 사용자의 실수 또는 악의적으로 주요 파일 정보를 변경할 수 있으므로 시스템 장애나 추가적인 공격에 활용될 수 있는 문제가 있다. 
    * find 명령의 "-perm -2" 옵션을 통해 others에 쓰기(w) 권한이 부여된 파일/디렉터리를 검색, others에 대한 쓰기 권한을 제거하거나 불필요한 파일/디렉터리인 경우 삭제
    ```sh
        # 검색
        $ find /home/ehdcjf -perm -2 -exec ls -al {} \;

        $ find /home/ehdcjf -perm -0002 -exec ls -al {} \;

        # 권한 제거
        $ chmod o-w /home/ehdcjf/sample.config

        # 파일 삭제
        $ rm -rf /home/ehdcjf/sample.config

    ```
<br>

4. 주요 파일 소유자 및 권한 설정
    * /etc/passwd : 사용자 정보를 담고 있는 파일로 root 소유의 644 이하의 권한 설정
    * /etc/shadow : 사용자의 암호화된 패스워드 정보를 담고 있는 파일로 root 이외에는 접근 못하도록 root 소유의 400 이하의 권한을 설정
    * /etc/host : IP와 호스트 이름을 매핑하는데 사요되는 파일로 외부의 불법적인 접근에 의한 조작 시 악의적인 시스템에 접근할 가능성이 있으므로 root 소유의 600 이하의 권한을 설정한다. 
    * /etc/(x)inetd.conf : inetd 데몬에 대한 설정파일로 외부의 불법적인 접근에 의해 악의적인 프로그램을 등록하고 root 권한으로 실행할 가능성이 있으므로 root 소유의 600 이하의 권한을 설정한다. 
    * /etc/syslog.conf : syslogd 데몬에 대한 설정파일로 주요 로그파일에 대한 설정 정보를 가지고 있다. 해당 파일의 접근권한이 적절하지 않아 외부의 불법적인 접근에 의하여 변경되는 경우 시스템 로그가 정상적으로 기록되지 않아 외부의 불법적인 접근에 의해 변경되는 경우 시스템 로그가 정상적으로 기록되지 않아 침입자의 흔적 또는 시스템 오류 사항을 정확히 분석할 수 없으므로 root 이외의 사용자는 해당 파일을 변경할 수 없도록 root 소유의 644 이하의 권한을 설정한다. 
    * /etc/services : 서비스 관리(서비스별 포트/프로토콜 정보)정보를 담고 있는 파일로 접근 권한이 적절하지 않아 외부의 불법적인 접근에 의해 변경되는 경우 정상적인 서비스를 제한하거나 허용되지 않는 서비스를 등록하는 등의 위험이 있으므로 root 소유의 644 이하의 권한을 설정한다. 


