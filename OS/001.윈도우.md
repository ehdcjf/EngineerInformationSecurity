# 윈도우 서버 보안

### 윈도우 인증과정
1. 윈도우 인증과정에서 사용되는 주요 서비스에는 LSA(Local Security Authority), SAM(Security Account Manager), SRM(Security Reference Monitor) 등이 있다. 
2. LSA
    * 모든 계정의 로그인에 대한 검증 및 시스템 자원(파일 등)에 대한 접근 권한을 검사한다.(로컬 및 원격 로그인 포함)
    * 계정명과 SID(Security ID)를 매칭하며 SRM이 생성한 감사 로그를 기록한다. 
    * NT 보안의 중심 서비스이며 보안 서브시스템이라 불린다. 

3. SAM 
    * 사용자/그룹 계정 정보에 대한 데이터베이스 관리
    * 사용자 로그인 정보와 SAM 파일에 저장된 사용자 패스워드 정보를 비교해 인증 여부를 결정
    * SAM 파일은 사용자, 그룹 계정 및 암호화된 패스워드 정보를 저장하고 있는 데이터 베이스로 윈도우 설치 디렉터리에 있다. 

4. SRM
    * 인증된 사용자에게 SID를 부여
    * SID를 기반으로 하여 파일이나 디렉터리에 대한 접근을 허용할지 여부를 결정하고 이에 대한 감사 메시지를 생성

### 로컬 인증 
윈도우 부팅 후 로그인 창에서 아이디와 패스워드를 입력하면 LSA 서브시스템이 인증정보를 받아 NTLM 모듈에 넘기고 이를 다시 SAM이 받아 로그인을 처리한다. 

### 원격(도메인) 인증
1. 윈도우 부팅 후 로그인창에서 아이디와 패스워드를 입력하면 LSA 서브시스템 인증 정보를 받아 로컬 인증용인지 도메인 인증용인지 확인하고 커버로스(Kerberos) 프로토콜을 이용해 도메인 컨트롤러에 인증을 요청한다. 
2. 도메인 컨트롤러는 인증 정보를 확인하여 접속하고자 하는 사용자에게 접근 토큰을 부여하고 해당 권한으로 프로세스를 실행한다. 

### SAM 파일 접근 통제 설정
1. SAM 파일은 사용자와 그룹 계정의 패스워드를 관리하고 LSA를 통한 인증을 제공하는 중요한 파일이므로 적절한 접근 통제가 필요하다. 
2. 공격자로부터 SAM 파일에 대한 패스워드 공격 시도에 따른 정보 노출의 위험이 있다.
3. 보안 설정
    __system32 > config > SAM__
    * SAM의 사용 권한에서  Administrators 및 System 그룹 이외에는 SAM 파일에 대한 접근을 제한한다. 
    * 불필요한 그룹 및 계정에 대해서는 권한을 제거한다. (Everyone)

### 윈도우 보안 식별자(SID:Security Identifier)
* 윈도우의 각 사용자나 그룹에 부여되는 고유한 식별번호
* 사용자가 로그인을 수행하면 접근 토큰(엑세스 토큰)이 생성되며, 해당 토큰에는 로그인한 사용자와 그 사용자가 속한 모든 작업 그룹들에 관한 보안 식별자(SID) 정보가 담겨있다. 
* 접근 토큰의 사본은 그 사용자에 의해 시작된 모든 프로세스에 할당된다. 
* 사용자 계정 및 패스워드 정보를 담고 있는 SAM 파일(c:\windows\system32\config)에 SID 정보가 저장되어 있다. 

#### SID 구조
|계정|SID|
|------|---|
|Administrator|S-1-5-21-4243233100-3174512425-4165118588-500|
|Guest|S-1-5-21-4243233100-3174512425-4165118588-501|
|일반 사용자 |S-1-5-21-4243233100-3174512425-4165118588-1001|

* S-1: 윈도우 시스템을 의미
* 5-21: 시스템이 도메인 컨트롤러이거나 단독 시스템임을 의미
* 4243233100-3174512425-4165118588: 해당 시스템만의 고유한 식별자. 동일한 컴퓨터에 다시 윈도우를 설치해도 동일한 값을 가지지 않는다. 
* 500,501,1000이상
    500: 관리자 식별자
    501: 게스트 식별자
    1000 이상: 일반 사용자 식별자

* 실행 > wmic > __useraccount list brief__ 명령 실행

### 윈도우 인증 구조
|사용자||윈도우|
|------|---|---|
|인증요청|>>||
|||Challenge 값 생성|
||<<|Challenge 값 전송|
|Response 값 생성|||
|Response 값 전송|>>||
|||Response 값 확인|
||<<|인증성공|

* 단순히 아이디워 패스워드를 전달하여 인증하는 방식은 정보 노출 및 패스워드 재사용 공격에 매우 취약하므로 운영체제 인증과 같은 높은 수준의 인증이 필요한 경우에는 적절하지 않다. 
* 윈도우에서는 Challenge & Response 방식의 인증 구조를 사용한다. 단계별 동작 방식은 다음과 같다. 
    1. 인증요청: 인증하고자 하는 사용자가 윈도우 시스템에 인증 요청한다. 
    2. Challenge 값 생성: 인증요청을 받은 서버는 특정한 규칙 또는 랜덤한 Challenge 값을 생성하여 사용자에게 전달한다. 
    3. Response 값 생성 및 전송: 사용자는 전달받은 Challenge 값과 사용자 패스워드 정보를 이용해 Response 값을 생성하여 서버에 전달한다. 
    4. Response 값 확인 및 인증 성공: 사용자가 전달한 Response 값을 확인하여 인증 성공 여부를 전달한다. 

#### 인증 암호 알고리즘
1. LM(Lan Manager) 해시: 윈도우 2000, XP의 기본 알고리즘으로 구조적으로 취약. 윈도우 비스타 이후 버전부터는 LM을 기본적으로 사용할 수 없게 함. 
2. NTLM 해시: LM 해시에 MD4 해시가 추가된 형태
3. NTLMv2 해시: 윈도우 비스타 이후 윈도우 시스템의 기본 인증 프로토콜로 기존 인증 알고리즘과는 전혀 다른 알고리즘으로 해시값을 생성하며 현재까지 복잡도가 충분해 크래킹이 어렵다. 

#### Lan Manager 인증 수준
1. Lan Manager 는 네트워크를 통한 파일 및 프린터 공유 등과 같은 작업 시 인증을 담담하는 서비스이다. 
2. Lan Manager 인증 수준 설정을 통해 네트워크 로그온에 사용할 Challenge/Response 인증 프로토콜을 결정하면, 이 설정은 클라이언트가 사용하는 인증 프로토콜 수준, 협상된 세션 보안 수준 및 서버가 사용하는 인증 수준에 영향을 주기 때문에 보다 안전한 인증을 위해 NTLMv2 사용을 권장한다. 


# 윈도우 서버 취약점

### 윈도우 서버 계정 관리

1. Administrator 계정 이름 변경
   * 관리자 계정은 컴퓨터 전체에 대한 모든 권한을 가진 계정이므로 특별한 관리가 필요. 
   * 기본 관리자 계정명인 Administrator를 그대로 사용할 경우 악의적인 공격자에 의한 패스워드 무차별 공격에 취약할 수 있다. 따라서 쉽게 유추하기 어려운 관리자 계정명으로 변경하는 것을 권장한다. 
   * 윈도우 관리자 계정의 경우 로그온 실패 횟수에 제한이 없는 특징이 있다. 
   * 계정명 확인
        > 제어판 > 관리도구 > 컴퓨터 관리 > 로컬 사용자 및 그룹 > 사용자에서 계정명 확인
   * 계정명 변경
        > 제어판 > 관리도구 > 로컬보안정책 > 로컬정책 > 보안옵션의 "계정: Administrator 계정 이름 바꾸기" 를 통해 관리자 계정명 변경
2. Guest 사용 제한. 
   * Guest 계정은 소프트웨어나 하드웨어 설치, 설정 변경, 암호 만들기 등을 할 수 없고 외부 사용자가 컴퓨터를 잠시 접근할 수 있는 계정이다. 
   * Guest 계정은 불특정 사용자의 시스템 접근을 허용하는 취약한 계정으로 사용 제한을 권장하며 불특정 다수의 접근이 필요한 경우 Guest 계정이 아닌 일반 사용자 계정을 생성해 사용하도록 해야한다. 
   * Guest 계정 사용 제한
        > 제어판 > 관리도구 > 컴퓨터 관리 > 로컬 사용자 및 그룹 > 사용자에서 Guest 계정 선택 후 "계정 사용 안 함" 적용

3. 불필요한 계정 제거
   * 불필요한 계정, 의심스러운 계정, 장기간 사용하지 않는 계정은 계정 정보 유출의 위험성이 있으므로 삭제 또는 계정 잠금 설정한다. 
        > 시작 > 프로그램 > 제어판 > 관리도구 > 컴퓨터 관리 > 로컬 사용자 및 그룹 > 사용자에서 불필요한 계정에 대한 삭제 또는 계정 사용 안 함 선택

4. 관리자 그룹에 최소한의 사용자 포함
   * 관리 업무를 수행하는 계정과 일반 업무를 수행하는 계정은 분리하여 사용하는 것이 바람직하며 관리자 그룹에는 최소한의 계정만을 포함
   * 관리자 그룹에 불필요한 계정이 있다면 해당 계정을 제거
  
5. 암호/패스워드 정책 설정
    * 패스워드 복잡성 설정
      - 패스워드 설정 시 영문자(대소)/숫자/특수문자를 모두 포함하여 보안적으로 안전한 패스워드를 만들어야한다. 
      - 윈도우 운영체제의 복잡성 기준
        > 영문 대문자, 영문 소문자, 숫자, 특수문자 중에서 2가지 종류를 조합했을 경우 최소 10자리 이상, 3가지 이상 종류를 조합했을 경우 8자리 이상의 길이가 되어야 한다. 
    * 최근 패스워드 기억 설정
        * 사용자가 최근에 사용했던 패스워드를 동일하게 사용할 수 없도록 설정한다. 
        * 최근 암호 기억을 12개 이상으로 권장
    * 패스워드 최대 사용기간 설정
        * 복잡한 패스워드를 설정한다고 해도 공격자가 무차별 공격으로 추정 가능한 암호에 대해서 크랙을 시도한다면 결국 이를 알아낼 수 있다. 따라서 주기적으로 패스워드를 변경하여 위험성을 줄여야한다. 
        * 최대 암호 사용기간(패스워드 만료 기간 90일 이하 권장)
        * 계정 속정의 "암호 사용 기간 제한 없음"을 해제 
    * 패스워드 최소 사용 기간 설정
      * 패스워드 변경에 시간적 제약이 없다면 "최근 패스워드 기억 설정"을 무력화하여 이전에 즐겨 사용하던 패스워드를 다시 사용할 수 있다. 따라서 최소 사용기간을 설정하여 해당 기간에는 패스워드를 변경하지 못하도록 설정한다. 
      * 최소 암호 사용 기간을 0보다 큰 값으로 설정(일반적으로 1일 설정)
    * 패스워드 최소 길이 설정
      * 적절한 길이의 패스워드로 설정하여 보안상 안전하고 사용자가 쉽게 기억할 수 있는 패스워드를 만들어야한다. 최소 암호길이 8자 이상 권장. 
    * 해독 가능한 암호화 사용 설정
      * 해독 가능한 암호 방식으로 저장할 경우 공격자의 암호 공격에 노출될 수 있다. 따라서 반드시 필요한 경우(다른 응용 프로그램에 의해 사용)를 제외하고는 "사용 안 함" 설정한다. 
6. 계정 잠금 정책
    * 계정 잠금 기간
      * 계정 잠금 기간을 설정하면 패스워드 틀린 횟수가 계정 잠금 임계값에 도달했을 때 지정한 기간(시간)동안 계정을 잠근다. 따라서 공격자의 무차별 공격에 효과적으로 대응할 수 있다. 
      * 계정 잠금 기간을 60분 이상으로 설정 권장
    * 계정 잠금 임계값 
      * 자동화된 방법을 통해 공격자는 패스워드에 대하여 무차별 공격을 시도할 수 있으므로 로글온 실패 횟수에 대한 제한이 필요한다. 계정 잠금 임계 값은 5 이하의 값이 권장 된다. (Administrator 계정은 잠기지 않는다)
    * 다음 시간 후 계정 잠금 수를 원래대로 설정
      * 실패한 로그온 시도 후 실패한 로그온 시도 카운트가 0으로 설정될 때까지 경과해야하는 시간을 지정한다. 60분 이상 설정 권장. 

### 윈도우 서버 서비스 관리
1. 하드디스크 기본 공유 제거
   * Windows는 프로그램 및 서비스를 네트워크나 컴퓨터 환경에서 관리하기 위해 시스템 기본 공유 항목을 자동으로 생성한다. 
      * 하드디스크 기본 공유 : C$ , D$
      * 원격 관리 및 IPC용 기본 공유: ADMIN$, IPC$ 
   * 하드디스크 기본 공유인 C$,D$ 등을 제거하지 않으면 기본 공유 폴더를 통해 인가받지 않은 사용자가 하드디스크 내의 폴더나 파일에 접근하거나 바이러스가 침투하는 경로가 될 수 있다.  
```
    net share C$ /delete

    net share D$ /delete    
```

   * 단 기본 공유의 경우. 공유 중지를 해도 운영체제가 재시작 되면 다시 생성되기 때문에 레지스트리 수정이 필요하다. 

2. 공유 권한 및 사용자 그룹 설정
   * 공유 폴더에 Everyone 그룹이 포합되어 있으면 익명 사용자에 의한 접근이 가능하므로 Everyone 그룹을 제거하도록 한다. 

3. 불필요한 서비스 제거
   * 취약한 서비스들이 디폴트로 설치되어 실행되고 있으면 이러한 서비스 또는 응용프로그램은 공격 지점이 될 수 있으므로 사용자 환경에서 필요하지 않은 서비스나 실행파일을 사요하지 않거나 제거한다. 
   * 주요 취약 서비스는 다음과 같다. 
        - Alerter: 서버에서 클라이언트로 경고 메세지를 보냄
        - Clipbook: 서버 내 Clipbook을 다른 클라이언트와 공유
        - Messenger: net send 명령어를 이요하여 클라이언트에게 메시지 보냄
        - Simple TCP/IP Services(Echo, Discard, Character Generator, Daytime, Quote of the Day)

### 윈도우 서버 로그관리
1. 감사 정책 설정
    * 윈도우 운영체제에서 말하는 감사 정책은 어떤 로그를 남길지를 정의한 규칙을 말한다. 감사 정책을 설정하게 되면 감사 정책에 의해 지정한 이벤트에 대해서만 로그가 남는다. 
    * 감사 설정이 구성되어 있지 않거나 감사 설정 수준이 너무 낮으면 보안 관련 문제 발생 시 원인을 파악하기 어려우며 법적 대응을 위한 증거로 사용될 수도 없다. 
    * 감사 설정이 너무 높으면 보안 로그에 불필요한 항복이 많이 기록되므로 매우 중요한 항목과 혼동할 수 있으며 시스템 성능에도 심각한 영향을 줄 수 있기 때문에 법적 요구 사항과 조직의 정책에 따라 필요한 로그를 남기도록 설정한다. 
  
2. 감사 항목
   
|감사항목|권장값|설명|
|--------|-----|---|
|개체 엑세스|감사 안함| 파일, 디렉토리, 레지스트리, 프린터 등의 객체에 대한 접근 성공/실패 여부를 기록할지 결정|
|계정 관리|실패| 계정 관리 이벤트를 감사할지 여부를 결정 <br> 사용자 계정 또는 그룹의 생성, 변경, 삭제, 암호의 설정 및 변경 등의 이벤트 성공/실패 로그를 기록|
|계정 로그온 이벤트|성공, 실패| 도메인 계정에 대한 로그온 성공/실패 관련 이벤트 로그를 기록할지를 결정|
|권한 사용|실패|권한 사용의 성공 및 실패를 감사할 경우 사용자 권한을 이용하려고 할 때마다 이벤트 생성|
|디렉터리 서비스 액세스|실패|Active Directory 개체의 시스템 액세스 컨트롤 목록(SACL)에 나열된 사용자가 해당 개체에 액세스를 시도할 때 이벤트 생성|
|로그온 이벤트|성공, 실패| 로컬 계정에 대한 로그온/오프 성공/실패에 대한 이벤트를 기록할지를 결정|
|시스템 이벤트|감사 안함|시스템 시작 또는 종료, 보안 로그에 영향을 미치는 이벤트등을 감사할지 여부를 결정|
|정책 변경|성공, 실패|감사 정책 변경의 성공 및 실패를 감사|
|프로세스 추적|감사 안함|실행되는 프로세스에 대한 자세한 추적정보를 감사하는 경우 프로세스 생성, 프로세스 종료, 핸들 복제 및 간접 개체 액세스 같은 프로세스 관련 이벤트를 감사할지 여부를 결정|
