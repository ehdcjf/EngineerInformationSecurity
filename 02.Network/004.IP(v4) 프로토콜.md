# IP 프로토콜
* 비연결형 프로토콜로 연결 상태를 유지하지 않기 때문에 패킷 전송 순서를 보장하지 않는다. 
* 비신뢰적 프로토콜로 신뢰성 있는 통신을 보장하지 않는다. 
* IP는 목적지 주소를 기반으로 라우팅을 담당하는 인터넷 계층의 대표 프로토콜이다. 라우팅은 알고리즘을 통해 최적 경로를 선정하여 목적지를 찾아가는 것을 말한다. 


# IP 프로토콜 구조
 <!-- IP 프로토콜 구조 이미지 -->
1. VER(4): IP 버전 정보 일반적으로 IPv4 사용
2. HELN(4): 헤더길이
3. Service Type(8): 서비스 품질(QoS)를 위한 용도이지만 현재 사용하지 않음
4. Total Length:(16): 헤더와 데이터를 포함한 전체 IP 필드
5. Identification:(16): 단편화/재조합 관련 필드
   * IP 데이터그램을 여러 조간을 분할하는 것을 단편화라고 하고 분할된 단편을 조합하여 원본IP 데이터그램을 완성하는 것을 재조합이라한다. 
   * 단편화 전 원본 IP 데이터 그램을 식별하기 위한 ID
6. Flag(3): 단편화/ 재조합 관련 필드
    * 첫번쨰 비트: 사용 안함
    * 두번째 비트: Don`t fragment bit(1 설정시 단편화하지 말라는 의미)
    * 세번째 비트: More fragment bit (1 설정시 재조합할 단편이 남아 있다는 의미이고, 0 설정 시 단편이 더 이상 없다는 의미)
7. Fragmentation offset(13): 단편화/재조합 관련 필드
    * IP의 특성상 원본 IP 데이터그램의 단편들이 순서대로 전송되는 것이 아니므로 이를 순서대로 조합하기 위한 현재 단편의 상대 위치를 저장한 필드
    * 8byte 단위로 표현
8. Time To Live(8): IP 패킷의 생존시간(Lifetime)을 지정하는 필드
    * 최초에 초단위로 생존 시간을 명시할 의도였으나 시간 측정의 어려움으로 인해 라우터/L3 스위치 통과 횟수(hop count)로 그 의미가 바뀜
    * 패킷이 라우터/L3스위치에 도착하면 TTL값을 1 감소시키고 그 값이 0 이되면 해당 패킷을 폐기한다. 
    * TTL을 성정하는 목적은 라우터/L3스위치를 통해 패킷 라우팅을 하던 중 무한루핑이 발생하여 목적지에 도달할 수 없는 패킷이 무한히 생존하여 네트워크 대역만 차지하는 상태를 방지하기 위함이다. 
    * 일반적으로 Linux는 64, Windows는 128, Unix는 255를 설정한다. 운영체제별로 부여하는 기본 TTL 값이 다르기 때문에 해당 필드를 OS 핑거프린트 목적으로 사용할 수 있다. 
9. Protocol(8): 상위 프로토콜을 실별하기 위한 프로토콜 번호를 저장하는 필드
    * 상위 프로토콜과 다중화/역다중화를 위한 식별값으로 ICMP(1), TCP(6), UDP(17)등이 있다. 
10. Header checksum(16): 데이터를 제외한 헤더 부분의 오류 검사 값
11. Source IP Address(32): 출발지 IP 주소
12. Destination IP Address(32): 목적지 IP 주소
13.  주요 IP 옵션 헤더
    * Loose Source Route: Source Route는 라우팅 경로를 라우터/L3 스위치가 아닌 출발지에서 지정하는 옵션으로 느슨한(Loose) 소스 라우팅은 경우에 따라 다른 경로로 라우팅할 수 있다. 
    * Strict Source Route: 엄격한(Stict) 소스 라우팅은 출발지에서 지정한 경로로 무조건 라우팅하는 옵션이다. 


# IP 단편화(Fragmentation)
<!-- IP 단편화 그림 -->
1. IP 패킷/데이터그램은 MTU에 따른 단편화가 발생한다. 
    * MTU(Maximum Transmission Unit): 물리적인 네트워크 프로토콜(Network interface 계층의 프로토콜) 프레임의 데이터부(Payload)의 최대 크기를 말한다. 
    * 물리적인 네트워크 프로토콜은 각자 물리적인 특성에 맞게 정의된 MTU를 가진다. IP 패킷이 LAN 또는 WAN의 다양한 프로토콜의 상위 프로토콜로 사용할 수 있는 이유가 이 단편화를 이용한 패킷의 크기 조절이 가능하기 떄문이다. 가장 많이 하용하는 이더넷의 경우 MTU는 1500바이트이다. 
    * IP 패킷이 프레임으로 캡슐화되기 때문에 MTU를 초과하는 크기가 될 수 없다. 예를 들어 대표적인 이너텟의 경우  MTU가 1500바이트 이기 떄문에 IP 패킷이 이보다 크다면 1500바이트 이하의 크기로 단편화하여 전송해야한다. 
2. 단편화는 최초 출발지 뿐만 아니라 라우터/L3스위치 중계 구간의 MTU에 따라 추가적으로 발생하지만, 단편화된 패킷은 통신 효율을 위해 중계 구간의 MTU가 달라진다고 해도 재조합되지 않으며 최종 목적지에서만 재조합된다. 

### 동작방식
<!-- IP 패킷 단편화 그림 -->
1. 첫 번째 단편은 데이터가 1480byte(IP 헤더 20byte를 포함하여 1500byte)이고 두 번쨰 단편이 있기 때문에 More fragments bit(3번째 비트) 가 1이고 Offset은 첫버째 단편이기 때문에 0으로 설정되어 있다. 모든 단편이 동일한 IP 데이터그램의 단편이기 때문에 단편 ID 는 동일하다. 
2. 두 번째 단편을 살펴보면 데이터는 1480byte(IP 헤더 20byte를 포함하여 1500byte)이고 세 번째 단편이 있기 때문에 More fragments bit(3번째 비트) 가 1이고 두 번째 단편은 첫 번째 단편 다음에 위치하기 때문에 1480으로 Offset이 설정되어 있다. 
3. 세 번째 단편을 살펴보면 데이터부는 48byte(IP 헤더 20byte를 포함하여 68byte)이고 마지막 단편이기 때문에 "More fragments bit" 가 0 이고 세번째 단편은 두번째 단편 다음에 위치하기 때문에 2960이 Offset으로 설정되 있다. 


# IP 라우팅(Routing)
### 라우팅 규칙

1. 목적지 주소와 자신의 주소가 동일한 경우 목적지가 자신이므로 상위 계층으로 데이터를 전달한다.
2. 목적지 주소가 자신과 동일한 네트워크에 있다면 직접 전송
3. 그렇지 않다면 1차 경유지(gateway) 주소를 라우팅 테이블을 참조하여 찾는다. 
   * 라우팅 테이블은 임의의 목적으로 가기 위한 경로 정보를 저장하고 있는 자료구조이다. `neststat -rn` 명령을 통해 호스트의 라우팅 테이블 정보를 확인할 수 있다. 

### 라우팅 테이블 검색 방식 및 우선 순위
* 검색방식: IP 패킷의 목적지 IP 와 라우팅 테이블의 netmask/genmask를 bit and(&)연산 수행 후 라우팅 테이블의 destination 필드와 비교, 일치하는 경로를 선택하여 패킷을 전송한다. 목적지 IP 에서 네트워크 ID부분만을 추출하기 위한 과정이다. 
* 검색 우선순위
  * 먼저 목적지 호스트(IP) 주소와 일치하는 경로를 찾는다. 
  * 목적지 호스트(IP) 주소와 일치하는 경로가 없으면 목적지 네트워크 주소와 일치하는 경로를 찾는다. 
  * 일치하는 경로가 없으면 default gateway(0.0.0.0)로 보낸다. 

||||||
|--|--|--|--|--|
|Destination|Gateway|Genmask|Flags|Interface|

* Destination: 목적지 호스트 또는 네트워크 주소
* Gateway: 목적지로 전송하기 위한 Gateway주소
* Genmask: 범용(General) 목적의 마스크로 다음과 같은 역할을 한다. 
  * 목적지 Host를 식별하기 위한 마스크: 255.255.255.255
  * 목적지 Network를 식별하기 위한 마스크: 넷마스크(Netmask)를 의미
  * default gateway를 식별하기 위한 마스크: 0.0.0.0
* Flags: 해당 경로에 대한 상태 정보 플래그
  * U(route is Up): 경로가 활성화되어 있음
  * G(use Gateway): gateway를 사용함
  * H(target is a Host): 목적지가 호스트를 의미
* Interface: 해당 목적지로 보내기 위한 인터페이스 이름

# IP Spoofing
* IP 스푸핑은 IP를 속이고 통신하는 공격으로  1995년 캐빈 미트닉이 이를 이용하여 실제 해킹을 시도함으로써 널리 알려진 공격방식이다. 
* 시스템 간의 트러스트(trust)관계를 이용, 트러스트 관계가 맺어진 서버와 클라이언트를 확인한 후 신뢰 관계가 있는 클라이언트를 불가능한 상태로 만들고(DoS 공격 등을 이용) 공격자가 클라이언트 IP로 위조(스푸핑)하여 서버에 접속하는 공격방식이다. 
  * 트러스트 관계 설정은 아이디, 패스워드 기반의 로그인이 아닌 신뢰 관계에 있는 IP를 등록하여 IP로 접근하는 것을 허용해주는 방식이다. 즉 IP주소로 인증하고 로그인 없이 접속할 수 있도록 해주는 방식이다. 트러스트 설정은 다수의 시스템을 관리하는 관리자의 입장에서 아이디와 패스워드를 관리해야하는 어려움을 해결하고 접속과정에서 아이디, 패스워드가 스니핑되는 위험성을 차단하지만 IP 스푸핑에는 매우 취약하기 때문에 보안상 사용하지 않는 것을 권장한다. 

### 트러스트 설정
* 유닉스/리눅스 시스템에서 트러스트 관계 설정 파일로 /etc/hosts.equiv와 $HOME/.rhost 파일이 있다. hosts.equiv 파일은 시스템 전체에 영향을 주는 파일이고 .rhost 파일은 사용자별로 설정하는 파일이다. 
* 설정방식은 다음과 같다. 

|레코드 형식| 의미|
|--|--|
|host_name|해당 호스트(IP 또는 호스트명)의 접근 허용|
|host_name user_name|해당 호스트에 해당 사용자로 접근 허용|
|+|모든 호스트의 접근을 허용(계정은 아이디, 패스워드 인증 필요)|
|+ user_name|모든 호스트의 해당 사용자로 접근 허용|
|-host_name|해당 호스트의 접근 차단|
|host_name -username|해당 호스트에서 해당 사용자만 접근 차단|
|+ @group|모든 호스트에서 해당 group 사용자로 접근 허용|


* 설정 방식을 보면 앞에 있는 것이 호스트명, 띄어쓰기 이후 나오는 것이 사용자명이다. + 는 모두 허용한다는 의미이고, - 는 차단한다는 의미이다. 
* "+ +"로 설정한다면 모든 호스트에 대해서 모든 계정을 신뢰한다는 의미이므로 매우 취약한 설정이다. 

### rlogin 서비스 활성화
* r계열 서비스는 인증 없이 신뢰 관계에 있는 시스템의 원격 접속을 허용해주는 서비스이다. rlogin의 경우 telnet과 유사하지만 인증 없이 접속할 수 있다. 
* xinetd 데몬의 rlogin 서비스를 활성화한 후 xinetd 데몬을 재기동한다. netstat 명령으로 소켓 상태를 확인해보면 513/tcp(rlogin 서비스)포트가 리슨 상태에 있는 것을 확인할 수 있다. 
* 원격 클라이언트에서 `rlogin 서버IP` 명령을 통해 접속하면 아이디, 패스워드 확인 없이 바로 연결되는 것을 확인할 수 있다. 
* 공격자는 신뢰 관계에 있는 클라이언트를 사용 불능 상태로 만든 후 해당 클라이언트의 IP를 위조하여 서버에 접속할 수 있다. 

### IP스푸핑 대응책
* 시스템 간 트러스트 설정을 사용하지 않는다. 
* 반드시 사용해야할 경우 트러스트된 시스템의 MAC주소를 정적으로 구성하여 단순 IP만을 위조한 접속을 차단한다. 


### $HOME/.rhost, host.equiv 사용금지
* r 계열 서비스 (rlogin, rsh, rexec 등)를 통한 원격 접속은 보안상 매우 취약하여 서비스 포트가 열려있을 경우 중요 정보 유출 등 침해사고의 원인이 될 수 있다. 따라서 r 계열 서비스를 허용하지 않는다. 
* 만약 불가피하게 사용할 경우에는 트러스트 관계 설정 파일인 $HOME/.rhosts, hosts.equiv에 적절한 보안 조치를 해야한다. 

* /etc/hosts.equiv 및 $HOME/.rhosts 파일 소유 그룹을 root 또는 해당 계정으로 변경한다.
* /etc/hosts.equiv 및 $HOME/.rhosts 파일 권한을 600 이하로 변경한다. 
* /etc/hosts.equiv 및 $HOME/.rhosts 파일에서 "+"를 제거하고 반드시 필요한 호스트 및 계정만 등록한다. 

# IPv6
* IPv6는 IPv4 주소가 고갈되는 문제를 해결하기 위해 새로운 128비트 체계로 2^128개의 주소를 갖는 인터넷 프로토콜 주소를 말한다. 
* IPv6 주소는 16비트 단위로 구분하며 각 단위는 16진수로 변환되어 콜론으로 구분하여 표기한다. 
* 128비트의 IPv6 주소에 앞서 64비트는 네트워크 주소를 의미하고 뒤의 64비트는 네트워크에 연결된 통신장비 등에 할당되는 인터페이스 주소를 의미한다. 

### IPv6 장점
* 확대된 주소 공간: 주소길이가 128비트로 증가하여 2^128개의 주소 사용 가능
* 단순해진 헤더 포맷: IPv4 주소 헤더의 불필요한 필드를 제거하여 보다 빠른 처리 가능
* 간편해진 주소 설정 가능: IPv6 프로토콜에 내장된 주소 자동 설정 기능을 이용하여 플러그 앤 플레이 설치가 가능
* 강화된 보안성: IPv6 주소에서는 IPSec 기능을 기본으로 제공
* 개선된 모바일 IP : IPv6 주소 헤더에서 이동성 지원

### IPv6 전환 기술
1. 듀얼스택:
   * IPv4와 IPv6 프로토콜을 동시에 설정하여 통신 상대에 따라 선택적으로 사용할 수 있도록 하는 방식
   * 호스트, 라우터 등에 듀얼스택을 적용하여 IPv4와 IPv6 패킷을 모두 처리할 수 있도록 해준다. 장기적으로 보았을 때 가장 추천되는 방식이다. 

2. 터널링:
    * IPv4 네트워크를 경우하여  IPv6 네트워크 간 통신을 위한 방식으로 IPv4 네트워크를 통과하는 가상의 경로를 만들어 통신하는 방식이다. 
    * 터널링 기술은 호스트와 라우터에서 IPv6패킷을 IPv4 패킷으로 캡슐화하여 전송함으로써 캡슐화된 IPv6 패킷이 IPv4네트워크를 통과하게 하는 기술이다. 

3. 주소/헤더 변환:
    * 주소변환 방식은 IPv4 주소를 IPv6주소로 변환하거나 IPv6 주소를 IPv4 주소로 변환하여 통신하는 방식을 말한다. 
    * 패킷의 앞부분에 변환 헤더를 추가함으로써 주소를 변환하여 송신하고 수신측에서 변환 헤더를 제거하는 방식으로 통신한다. 
    * 소수의 IPv6 사이트가 대규모의 IPv4 인터넷에 연결되는 전환의 초기단계과 소수의 IPv4 사이트가 대규모의 IPv6 인터넷에 연결되는 전환의 마지막 단계에 사용할 수 있다. 



