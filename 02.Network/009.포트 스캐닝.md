# 포트스캐닝
* 포트스캐닝은 공격자가 침입 전 대상 호스트에 어떤 포트가 활성화되어 있는지 확인하는 기법으로 침입 전 취약점을 분석하기 위한 사전 작업 중 하나이다. 
* 포트스캐닝을 통해 대상 호스트의 동작여부와 제공하는 서비스 등을 확인할 수 있다. 일반적으로 포트 스캐닝을 수행하기 위한 포트스캐너로 nmap을 많이 사용한다. 

# nmap 포트스캐너 사용법
|문법|nmap [scan type] [options] <target>|
|---|---|
|Scan Type|-sS :TCP SYN(Half-Open) Scan, TCP 포트 오픈 여부를 확인하는 스캔 <br> -sT :  TCP Connect(Open) Scan: TCP 포트 오픈 여부를 확인하는 스캔<br> -sU  :  UDP Scan: UDP 포트 오픈 여부를 확인하는 스캔<br> -sF  :  TCP FIN 제어비트를 이용한 스캔<br> -sX  :  TCP FIN, PSH, URG 제어비트를 조합한 패킷을 이용한 스캔<br> -sN  :  TCP NULL Scan: TCP 제어비트 설정이 없는 NULL 패킷을 이용한 스캔<br> -sA  :  TCP ACK Scan: 방화벽 룰셋(필터링 정책)을 확인하기 위한 스캔<br> -sP  :  Ping(icmp/icmp echo) Scan, Ping을 이용해 호스트 활성화 여부를 확인하는 스캔<br> -D  :  Decoy 스캔: 실제 스캐너 주소 외에도 다양한 주소로 위조하여 스캔하는 방식<br> -b  :  TCP FTP Bounce Scan, -b \<FTP bounce proxy\> <br>|
|Port Option| -p 22: 22번 포트 스캔<br>-p <service>: 특정 서비스명(e.g. ssh)으로 포트 스캔<br>-p 20,25,80: 여러 포트 스캔<br>-p 1-1023: 일정 범위로 포트 스캔 <br>-pT:21,23,110,U:53 : TCP 21,223,110번 포트와 UDP 53번 포트를 분리하여 포트 스캔|
|Output Option|-v: 상세내역 출력 <br>-d : Debugging<br>-oN <file> :결과를 일반 파일 형식으로 출력 <br>-oX <file> :결과를 XML 형식으로 출력 <br>-oG <file> : 결과를 Grepable(grep, awk 등으로 분석하기 편한) 파일 형식으로 출력 <br>-oA <Directory> : 일반(.nmap),XML(.xml), Grepable(.gnmap) 파일로 출력|
|기타 옵션| - -O: 영어 대문자 O, 대상 호스트의 운영체제 정보 출력 <br> -F: 빠른 네트워크 스캐닝 <br> -T0~T5: T0 아주 느리게 ~ T5 아주 빠르게|
|Target| - hostname지정 <br>ex) www.ehcjf.com <br> - IP Address, Network 등 가능 <br> ex) 192.168.127.57: 특정 IP 지정<br> ex) 192.168.57.0/24: 192.168.57 대역 지정<br> ex) 192.168.57.100-150 특정범위(100-150)지정|


# TCP Connect(Open) 스캔
* 일반 사용자 권한으로 TCP 포트 오픈 여부를 확인하기 위해 connect 시스템 호출(system call)을 이용하는 방식으로 스캔 대상 포트별로 정상적인 TCP 연결 설정을 수행하여 스캔하는 방식이다. 
* TCP 등 프로토콜 패킷 자체를 사용자가 직접 조작하여 생성하려면 관리자 권한이 필요하다. TCP SYN 스캔 등 대부분의 스캔 방식들이 관리자 권한으로 패킷을 직접 조작해 스캔하는 방식이며 이러한 권한이 없을 경우 일반 사용자 권한으로 사용할 수 있는 시스템 호출을 이용하는 TCP Connect 스캔을 이용한다. 
* 포트 스캔 과정에서 connect 시스템 호출을 통해 TCP 연결설정 과정을 완전하게 수행하여 Target 호스트의 포트에 직접 연결되기 떄문에 Open 스캔이라고도 하며 시스템 로그에 스캔한 흔적이 남는 특성이 있다. 
  
### OPEN/CLOSED 상태 동작방식
<!-- ### OPEN/CLOSED 상태 동작방식 이미지-->
1. 먼저 Target 호스트의 대상 포트로 SYN 패킷을 전송한다. 전송 후 포트 오픈 여부에 따라 다음과 같은 응답 패킷을 수신한다. 
    * 포트가 열린 상태: SYN+ACK 응답을 수신한 후 ACK 패킷을 전송하여 TCP 연결을 완료한다.(connect 시스템 호출 동작 방식)
    * 포트가 닫힌 상태: RST+ACK 응답을 수신한다. 
2. 대상 포트가 열린 상태에서 연결설정이 완료되고(3-way handshake 과정)나면 포트 오픈 여부를 확인했기 때문에 연결을 즉시 중단하기 위해 RST+ACK 패킷을 전송한다. 
3. TCP 연결 설정이 이루어지기 때문에 (이를 TCP 세션이 성립된 상태라고도 표현함) 대상 호스트의 시스템 로그에 스캔을 시도한 IP 주소가 남는다는 특징이 있다. 
<!-- 실습해보기  nmap -T4 -sT -p 23,80 192.168.57.128 -->

### FILTERED 상태 동작방식
<!-- ### FILTERED 상태 동작방식 이미지-->
1. Target 호스트의 포트가 방화벽에 의해 필터링되고 있다면 방화벽 차단 정책에 따라 응답이 없거나 ICMP 에러 메시지(Destination Unreachable) 응답을 받을 수 있다. 방화벽 필터링(차단) 정책은 보안상의 이유로 응답하지 않도록 설정하는 것이 일반적이다. 
    * iptables 방화벽의 경우 DROP 차단 정책을 사용하면 해당 패킷을 폐기한 후 아무런 응답을 하지 않고, REJECT 차단 정책을 사용하면 해당 패킷을 폐기한 후 설정된 ICMP 에러 메시지(Destination Unreachable)를 응답한다. 


# TCP SYN(Half-Open) 스캔
* 관리자 권한으로 TCP 패킷(raw packet)을 직접 조작하여 TCP 포트 오픈 여부를 판단하는 스캔방식이다. 
* 포트 스캔 과정에서 TCP 패킷 헤더의 제어비트를 조작, TCP 연결설정 과정을 완전하게 수행하지 않기 때문에 Half-Open 스캔 이라고 한다. 
* 스텔스 스캔 방식: TCP 세션이 완전히 성립되지 않은 상태에서(TCP 연결 설정 미완료 상태) 대상 시스템 포트 활성화(오픈) 여부를 알아내는 스캔방식으로 TCP 연결 설정이 완전히 이루어지지 않기 때문에 스캔 대상 시스템에 로그가 남지 않아 공격자는 자신의 IP를 노출시키지 않으면서 스캔할 수 있는데 이렇게 흔적을 남기지 않는다는 의미에서 스텔스 스캔이라 한다. 
  * 대표적인 스텔스 스캔 방식으로 TCP SYN Scan, TCP FIN Scan, TCP NULL Scan, TCP Xmas Scan 등이 있다. 

### OPEN/CLOSED 상태 동작방식
<!-- ### OPEN/CLOSED 상태 동작방식 이미지-->
1. 먼저 Target 호스트의 대상 포트로 SYN 패킷을 전송한다. 전송 후 포트 오픈 여부에 따라 다음과 같은 응답 패킷을 수신한다. 
    * 포트가 열린 상태: SYN + ACK 응답을 수신한다. 
    * 포트가 닫힌 상태: RST + ACK 응답을 수신한다. 
2. 대상 포트가 열린 상태이면 Target 호스트로부터 SYN + ACK 응답이 오고 해당 응답만으로도 포트가 열린 상태임을 알 수 있기 때문에 연결을 완료하지 않고 패킷 조작을 통해 증시 중단을 위한 RST 패킷을 전송한다. 

### FILTERED 상태 동작방식
<!-- ### FILTERED 상태 동작방식 이미지-->
* TCP Connect 스캔과 동일하게 Target 호스트의 포트가 방화벽에 의해 필터링 되고 있다면 방화벽 차단 정책에 따라 응답이 없거나 ICMP 에러 메시지 응답을 받을 수 있다. 

# TCP FIN/NULL/Xmas 스캔
* 관리자 권한으로 TCP 패킷 자체를 직접 조작하여 TCP 포트 오픈 여부를 판단하는 방식이다. 
* TCP 세션을 생성하지 않고 스캔하는 스텔스 스캔 방식으로 TCP 패킷 헤더의 제어비트를 비정상적으로 설정해서 스캔한다. 스캔 방식에 따른 제어비트 설정 방식은 다음과 같다. 
  * TCP FIN 스캔: FIN 제어비트만 설정하여 스캔하는 방식으로 TCP 표준에서 연결 종료 패킷은 FIN+ACK 제어비트만 사용한다. 
  * TCP NULL 스캔: 제어 비트 설정하지 않고 스캔하는 방식으로 TCP 표준에서 사용하지 않는 설정이다. 
  * TCP Xmas 스캔:  URG, PSH, FIN 제어비트를 설정하여 스캔하는 방식으로 TCP 표준에서 사용하지 않는 방식이다. 
* TCP 표준(RFC 793)의 다음 특성을 이용하여 포트 오픈 여부를 확인한다. 
  * 닫힌 포트로 RST 이외의 패킷을 수신한 경우 RST 패킷으로 응답한다. 
  * 열림 포트로 SYN, ACK 또는 RST 이외의 패킷을 수신한 경우 이를 폐기하고 응답하지 않는다. 
  * 따라서 위와 같은 TCP 표준 동작방식을 준수하는 시스템이라면 SYN, ACK 또는 RST 이외의 패킷을 수신한 경우 닫힌 포트에서는 RST 패킷으로 응답하고 열린 포트에서는 응답하지 않는다. 

### TCP FIN 스캔: OPEN/CLOSED 상태 동작방식
<!-- ### TCP FIN 스캔: OPEN/CLOSED 상태 동작방식 이미지 -->
* Target 호스트의 대상 포트로 FIN 제어비트만 설정한 패킷을 전송한다. 전송 후 포트 오픈 여부에 따라 다음과 같은 응답 패킷을 수신한다. 
    * 포트가 열린 상태: 응답없음
    * 포트가 닫힌 상태: RST+ACK 응답 수신

### TCP NULL 스캔: OPEN/CLOSED 상태 동작방식
<!--### TCP NULL 스캔: OPEN/CLOSED 상태 동작방식이미지 -->

* Target 호스트의 대상 포트로 제어비트를 아무것도 설정하지 않은 패킷을 전송한다. 전송 후 포트 오픈 여부에 따라 다음과 같은 응답 패킷을 수신한다. 
    * 포트가 열린 상태: 응답없음
    * 포트가 닫힌 상태: RST+ACK 응답 수신

### TCP Xmas 스캔: OPEN/CLOSED 상태 동작방식
<!-- ### TCP Xmas 스캔: OPEN/CLOSED 상태 동작방식이미지 -->

* Target 호스트의 대상 포트로 URG, PSH, FIN 제어비트를 설정한 패킷을 전송한다. Xmas라고 이름을 붙인 이유는 크리스마스 트리처럼 제어비트를 반짝거리게 설정했다는 의미이다.  전송 후 포트 오픈 여부에 따라 다음과 같은 응답 패킷을 수신한다. 
    * 포트가 열린 상태: 응답없음
    * 포트가 닫힌 상태: RST+ACK 응답 수신


### TCP FIN/NULL/Xmas 스캔: FILTERED 상태 동작방식
<!-- ### TCP FIN/NULL/Xmas 스캔: FILTERED 상태 동작방식 이미지-->
* TCP Connect 스캔과 동일하게 Target 호스트가 방화벽에 의해 필터링 되고 있다면 방화벽 차단 정책에 따라 응답이 없거나 ICMP 에러 메시지 응답을 받을 수 있다. 


# TCP ACK 스캔
* Target 호스트의 스캔 여부를 판단하는 것이 아니라 방화벽 룰셋(필터링 정책)을 알아내기 위한 스캔방식
* Target 호스트의 대상 포트로 ACK 제어비트만 설정한 패킷을 전송하면 방화벽 룰셋에 따라 다음과 같은 응답을 확인할 수 있다. 
  * 방화벽에 의해 차단된 상태: 방화벽으로부터 응답이 없거나 ICMP에러 메시지 응답을 수신
  * 방화벽에 의해 허용된 상태: Target 호스트로부터 포트오픈 여부와는 무관하게 RST응답을 수신한다. TCP 표준에 따르면 열린 포트에 ACK를 수신한 경우 RST로 응답하고 닫힌 포트로 ACK를 수신한 경우(RST 이외의 패킷)에도 RST로 응답한다. 
* 방화벽에서 허용된 경우, Target 호스트의 포트 오픈 여부에 상관없이 RST 응답을 수신하기 때문에 TCP ACK 스캔은 포트 오픈 여부를 판단할 수 없다. 

### 동작방식
<!-- TCP ACK 스캔 동작방식 이미지-->
* Target 호스트의 대상 포트로 ACK 제어비트만 설정한 패킷을 전송한다.  전송 후 필터링 정책의 차단/허용 여부에 따라 다음과 같은 응답 패킷을 수신한다. 
    * 차단 상태: 방화벽으로부터 응답이 없거나 ICMP 에러 메시지 수신
    * 허용 상태: Target 호스트로부터 RST응답 수신

# UDP 스캔
* Target 호스트의 UDP 포트 오픈 여부를 판단하는 스캔방식으로 닫힌 UDP 포트로 패킷을 수신 시 ICMP 에러 메시지(Type3:Destination Unreachable, Code3:Port Unreachable)로 응답하는 특성을 이용한다. 

### OPEN/CLOSED 상태 동작방식
<!-- UDP 스캔 OPEN/CLOSED 상태 동작방식 이미지-->
* Target 호스트의 대상 포트로 UDP 패킷을 전송한다. 전송 후 포트 오픈 여부에 따라 다음과 같은 응답 패킷을 수신한다. 
    * 포트가 열린 상태: UDP 응답을 수신하거나 응답 없음
    * 포트가 닫힌 상태: ICMP 에러 메시지 응답 수신

### FILTERED 상태 동작방식
<!-- UDP 스캔 FILTERED 상태 동작방식이미지-->
* TCP Connect 스캔과 동일하게 Target 호스트가 방화벽에 의해 필터링 되고 있다면 방화벽 차단 정책에 따라 응답이 없거나 ICMP 에러 메시지 응답을 받을 수 있다. 


# Decoy 스캔
* Decoy 스캔은 다양한 포트 스캔을 수행할 때 스캔을 당하는 Target 호스트에서 스캐너 주소를 식별하기 어렵도록 실제 스캐너 주소 외에 다양한 위조된 주소로 스캔하는 방식을 말한다. 
* 다양한 IP 로 스캐너 주소를 위조하여 Target 호스트의 관리자가 스캔을 누가 하는지 알아채기 어렵도록 한다. 









